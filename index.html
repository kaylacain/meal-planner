<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meal Planner</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ó</text></svg>" />
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ó</text></svg>" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  :root {
    --bg: #f5f5f0;
    --surface: #ffffff;
    --surface2: #f0f4ed;
    --border: #e2e8df;
    --accent: #5a8a5a;
    --accent-light: #e8f2e8;
    --accent-dark: #3d6b3d;
    --text: #1a1f1a;
    --text-muted: #6b7a6b;
    --breakfast: #f5dfa8;
    --breakfast-border: #c49a2a;
    --lunch: #b8d4b0;
    --lunch-border: #4e8c45;
    --snacks: #d4c5f0;
    --snacks-border: #7c52c8;
    --dinner: #e8b49a;
    --dinner-border: #b85a35;
    --shadow: 0 2px 8px rgba(30,50,30,0.07);
    --shadow-lg: 0 8px 24px rgba(30,50,30,0.11);
    --radius: 16px;
    --radius-sm: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    letter-spacing: -0.01em;
  }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  header {
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    align-items: stretch;
    gap: 0;
    height: 56px;
  }

  .logo {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    padding-right: 28px;
    border-right: 1px solid var(--border);
    margin-right: 4px;
  }

  .logo span { font-size: 1.2rem; }

  nav {
    display: flex;
    gap: 0;
    flex: 1;
    align-items: stretch;
  }

  nav button {
    padding: 0 20px;
    border: none;
    background: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.15s;
    height: 100%;
    display: flex;
    align-items: center;
  }

  nav button:hover { color: var(--text); background: var(--surface2); }
  nav button.active {
    color: var(--accent-dark);
    border-bottom-color: var(--accent);
    font-weight: 600;
    background: none;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    padding-left: 16px;
  }

  .btn-icon {
    width: 32px; height: 32px;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.9rem;
    transition: all 0.15s;
    color: var(--text-muted);
  }
  .btn-icon:hover { background: var(--surface2); color: var(--text); }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 20px;
  }

  .view { display: none; }
  .view.active { display: block; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    padding: 9px 20px;
    border: none;
    border-radius: 99px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
  }
  .btn-primary:hover { background: var(--accent-dark); }
  .btn-primary:disabled { background: #b5ceba; cursor: not-allowed; }

  .btn-secondary {
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--surface2); }

  .btn-ghost {
    background: none;
    color: var(--accent-dark);
    padding: 6px 14px;
    border-radius: 99px;
  }
  .btn-ghost:hover { background: var(--accent-light); }

  .btn-sm { padding: 6px 14px; font-size: 0.8rem; border-radius: 99px; }
  .btn-danger { background: #fee2e2; color: #dc2626; border-radius: 99px; }
  .btn-danger:hover { background: #fecaca; }

  /* ‚îÄ‚îÄ WEEK VIEW ‚îÄ‚îÄ */
  .week-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .week-title { font-size: 1.25rem; font-weight: 800; color: var(--text); }
  .week-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 3px; font-weight: 400; }

  .week-actions { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

  .week-grid {
    display: grid;
    grid-template-columns: 88px repeat(7, 1fr);
    gap: 1px;
    background: var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .grid-cell {
    background: var(--surface);
    padding: 6px;
    min-height: 72px;
  }

  .grid-header {
    background: var(--surface2);
    min-height: auto;
    padding: 8px 4px;
    text-align: center;
    font-weight: 500;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .grid-header.today {
    background: var(--accent);
    color: white;
  }

  .day-name {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-weight: 600;
    color: inherit;
  }
  .day-num { font-size: 1.1rem; font-weight: 800; margin-top: 2px; color: var(--text); }
  .grid-header.today .day-num { color: white; }

  .grid-row-label {
    background: var(--surface2);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    min-height: 80px;
    padding: 8px 4px;
  }

  .grid-row-label .meal-pill {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    font-size: 0.58rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 4px 6px;
    line-height: 1.2;
    white-space: nowrap;
  }

  .grid-row-label .meal-pill.breakfast { background: var(--breakfast); border-color: var(--breakfast-border); color: #7a5a00; }
  .grid-row-label .meal-pill.lunch     { background: var(--lunch);     border-color: var(--lunch-border);     color: #2d5e25; }
  .grid-row-label .meal-pill.snacks    { background: var(--snacks);    border-color: var(--snacks-border);    color: #4a2d8a; }
  .grid-row-label .meal-pill.dinner    { background: var(--dinner);    border-color: var(--dinner-border);    color: #7a2e10; }

  .meal-slot {
    min-height: 72px;
    cursor: default;
    transition: background 0.12s, outline 0.1s;
    position: relative;
    padding: 4px;
    display: flex;
    flex-direction: column;
  }
  .meal-slot.drag-over {
    outline: 2px dashed var(--accent);
    outline-offset: -2px;
    filter: brightness(0.93);
  }

  .meal-slot.breakfast { background: color-mix(in srgb, var(--breakfast) 18%, var(--surface)); }
  .meal-slot.lunch     { background: color-mix(in srgb, var(--lunch) 18%, var(--surface)); }
  .meal-slot.snacks    { background: color-mix(in srgb, var(--snacks) 18%, var(--surface)); }
  .meal-slot.dinner    { background: color-mix(in srgb, var(--dinner) 18%, var(--surface)); }

  .meal-slot:hover { filter: brightness(0.97); }

  .meal-slot.empty {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .meal-slot .add-btn {
    width: 26px; height: 26px;
    border-radius: 50%;
    border: 1.5px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.5);
    font-size: 0.9rem;
    color: rgba(0,0,0,0.25);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }

  .meal-slot.empty:hover .add-btn {
    border-color: rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.85);
    color: rgba(0,0,0,0.5);
    transform: scale(1.1);
  }

  .meal-card-mini {
    padding: 5px 7px;
    display: flex;
    flex-direction: column;
    background: rgba(255,255,255,0.82);
    border: 1px solid rgba(255,255,255,0.9);
    border-radius: 8px;
    margin-bottom: 4px;
    cursor: grab;
    box-shadow: 0 1px 3px rgba(0,0,0,0.07);
    backdrop-filter: blur(4px);
  }
  .meal-card-mini:active { cursor: grabbing; }
  .meal-card-mini.dragging { opacity: 0.4; }
  .meal-card-mini:last-of-type {
    margin-bottom: 0;
  }
  .add-more-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 4px;
    align-self: center;
    width: 18px; height: 18px;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-muted);
    background: none;
    border: 1px solid var(--border);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.15s;
    line-height: 1;
    padding: 0;
  }
  .add-more-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .meal-card-mini .meal-name {
    font-size: 0.78rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--text);
    margin-bottom: 4px;
    flex: 1;
  }

  .meal-card-mini .meal-actions {
    display: flex;
    gap: 2px;
    margin-top: 4px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .meal-slot:hover .meal-card-mini .meal-actions { opacity: 1; }

  .meal-card-mini .meal-actions button {
    padding: 2px 5px;
    font-size: 0.65rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: rgba(255,255,255,0.75);
    color: var(--text-muted);
    transition: all 0.1s;
    backdrop-filter: blur(4px);
  }

  .meal-card-mini .meal-actions button:hover {
    background: rgba(255,255,255,0.98);
    color: var(--text);
  }

  /* ‚îÄ‚îÄ SLOT CHOICE CARDS ‚îÄ‚îÄ */
  .slot-choice-card {
    display: flex;
    align-items: center;
    gap: 14px;
    width: 100%;
    padding: 16px 18px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    cursor: pointer;
    text-align: left;
    transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
    margin-bottom: 10px;
  }
  .slot-choice-card:hover {
    border-color: var(--accent);
    background: var(--accent-light);
    box-shadow: var(--shadow);
  }
  .slot-choice-card:last-child { margin-bottom: 0; }
  .slot-choice-icon {
    font-size: 1.6rem;
    flex-shrink: 0;
    line-height: 1;
  }
  .slot-choice-label {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }
  .slot-choice-sub {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 2px;
    font-weight: 400;
  }
  .slot-back-btn {
    display: none;
    align-items: center;
    gap: 6px;
    border: none;
    background: none;
    color: var(--text-muted);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    padding: 0;
    margin-bottom: 16px;
    transition: color 0.12s;
  }
  .slot-back-btn:hover { color: var(--text); }
  .slot-panel { display: none; }
  .slot-panel.active { display: block; }
  .slot-section-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: var(--text-muted);
    margin-bottom: 8px;
    margin-top: 16px;
  }
  .slot-section-label:first-child { margin-top: 0; }

  /* ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ */
  .sync-status {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 99px;
    background: var(--surface2);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .sync-status:hover { background: var(--border); }

  .sync-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #ccc;
    flex-shrink: 0;
    transition: background 0.3s;
  }

  .sync-status.syncing .sync-dot { background: #f59e0b; animation: pulse 1s infinite; }
  .sync-status.synced  .sync-dot { background: #22c55e; }
  .sync-status.error   .sync-dot { background: #ef4444; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  @media (max-width: 600px) {
    .sync-label { display: none; }
    .sync-status { padding: 4px 6px; }
  }

  /* ‚îÄ‚îÄ SLOT SAVED RECIPE PICKER ‚îÄ‚îÄ */
  .slot-pick-tab.active {
    color: var(--accent-dark) !important;
    border-bottom-color: var(--accent) !important;
  }

  .slot-saved-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.12s;
    gap: 8px;
  }

  .slot-saved-item:hover { background: var(--accent-light); }

  .slot-saved-item .ssi-name {
    font-size: 0.875rem;
    font-weight: 600;
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .slot-saved-item .ssi-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .slot-saved-item .ssi-add {
    padding: 3px 10px;
    font-size: 0.75rem;
    font-weight: 700;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 99px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    transition: background 0.12s;
  }

  .slot-saved-item .ssi-add:hover { background: var(--accent-dark); }

  /* ‚îÄ‚îÄ INGREDIENT BUILDER ‚îÄ‚îÄ */
  /* ‚îÄ‚îÄ Photo import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .photo-dropzone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    background: var(--surface2);
    user-select: none;
  }
  .photo-dropzone:hover, .photo-dropzone:active {
    border-color: var(--accent);
    background: var(--accent-light);
  }
  .photo-dropzone-icon { font-size: 2rem; margin-bottom: 6px; }
  .photo-dropzone-text { font-size: 0.88rem; font-weight: 600; color: var(--text); }
  .photo-dropzone-sub  { font-size: 0.76rem; color: var(--text-muted); margin-top: 4px; }

  .photo-thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 12px;
  }
  .photo-thumb {
    position: relative;
    width: 90px;
    height: 90px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .photo-thumb-remove {
    position: absolute;
    top: 3px;
    right: 3px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(0,0,0,0.55);
    color: #fff;
    border: none;
    font-size: 0.7rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  /* ‚îÄ‚îÄ end photo import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

  .ing-builder {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--surface2);
  }

  .ing-row {
    display: grid;
    grid-template-columns: 72px 110px 1fr 28px;
    gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  .ing-row:last-child { border-bottom: none; }

  .ing-row input, .ing-row select {
    border: none;
    border-right: 1px solid var(--border);
    border-radius: 0;
    padding: 7px 8px;
    font-size: 0.82rem;
    background: transparent;
    width: 100%;
    min-width: 0;
  }

  .ing-row input:last-of-type, .ing-row .ing-name {
    border-right: none;
  }

  .ing-row input:focus, .ing-row select:focus {
    background: #fffef8;
    outline: none;
    box-shadow: inset 0 0 0 2px var(--accent);
    z-index: 1;
    position: relative;
  }

  .ing-row .ing-name { border-right: 1px solid var(--border); }

  .ing-row .ing-del {
    width: 28px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex; align-items: center; justify-content: center;
    transition: color 0.1s, background 0.1s;
  }

  .ing-del:hover { background: #fee2e2; color: #dc2626; }

  .ing-builder-header {
    display: grid;
    grid-template-columns: 72px 110px 1fr 28px;
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .ing-builder-header span {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    padding: 0 8px;
  }

  .ing-add-row {
    padding: 6px 8px;
    background: var(--surface2);
  }

  .servings-control {
    display: flex;
    align-items: center;
    gap: 3px;
    margin-top: 5px;
  }

  .servings-control button {
    width: 18px; height: 18px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 3px;
    background: rgba(255,255,255,0.8);
    cursor: pointer;
    font-size: 0.75rem;
    line-height: 1;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.1s;
    padding: 0;
    color: var(--text);
    flex-shrink: 0;
  }

  .servings-control button:hover { background: rgba(255,255,255,1); }

  .servings-control .servings-count {
    font-size: 0.7rem;
    font-weight: 700;
    min-width: 14px;
    text-align: center;
    color: var(--text);
  }

  .servings-control .servings-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-left: 1px;
  }

  /* ‚îÄ‚îÄ GROCERIES ‚îÄ‚îÄ */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 28px 0 16px;
  }

  .section-title { font-size: 1.15rem; font-weight: 800; }

  .grocery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .grocery-category {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .grocery-category h4 {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .grocery-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.875rem;
  }

  .grocery-item:last-child { border-bottom: none; }

  .grocery-item input[type="checkbox"] {
    width: 16px; height: 16px;
    accent-color: var(--accent);
    cursor: pointer;
    flex-shrink: 0;
  }

  .grocery-item label {
    cursor: pointer;
    flex: 1;
    line-height: 1.4;
  }

  .grocery-item input:checked + label {
    text-decoration: line-through;
    color: var(--text-muted);
  }

  /* ‚îÄ‚îÄ RECIPE SEARCH ‚îÄ‚îÄ */
  .recipes-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .search-bar {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 520px;
  }

  .search-bar input {
    flex: 1;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.15s;
    background: var(--surface);
  }

  .search-bar input:focus { border-color: var(--accent); }

  .recipe-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
  }

  .recipe-tab {
    padding: 8px 16px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-muted);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.15s;
  }

  .recipe-tab:hover { color: var(--text); }
  .recipe-tab.active { color: var(--accent-dark); border-bottom-color: var(--accent); font-weight: 600; }

  .week-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
  }
  .week-tab {
    padding: 6px 16px;
    border: 1px solid var(--border);
    background: var(--surface);
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-muted);
    border-radius: 99px;
    transition: all 0.15s;
  }
  .week-tab:hover { color: var(--text); background: var(--surface2); }
  .week-tab.active {
    color: white;
    background: var(--accent);
    border-color: var(--accent);
    font-weight: 600;
  }

  .recipe-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
  }

  .recipe-card {
    background: var(--surface);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    transition: box-shadow 0.2s, transform 0.2s;
    display: flex;
    flex-direction: column;
  }

  .recipe-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
  }

  .recipe-img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--border);
  }

  .recipe-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .recipe-body {
    padding: 14px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .recipe-title {
    font-size: 0.95rem;
    font-weight: 800;
    line-height: 1.3;
    margin-bottom: 8px;
  }

  .recipe-meta {
    display: flex;
    gap: 12px;
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-bottom: 10px;
    flex-wrap: wrap;
  }

  .recipe-meta span { display: flex; align-items: center; gap: 3px; }

  .recipe-ingredients {
    font-size: 0.78rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 12px;
    flex: 1;
  }

  .recipe-ingredients strong { color: var(--text); font-weight: 600; }

  .recipe-footer {
    display: flex;
    gap: 6px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border-radius: var(--radius);
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.2s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 1;
  }

  .modal-title { font-size: 1.05rem; font-weight: 700; }

  .modal-body { padding: 20px; }

  .modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .close-btn {
    width: 30px; height: 30px;
    border: none;
    background: var(--surface2);
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
  }

  .close-btn:hover { background: var(--border); }

  /* ‚îÄ‚îÄ API KEY PROMPT ‚îÄ‚îÄ */
  .api-setup {
    max-width: 480px;
    margin: 60px auto;
    background: var(--surface);
    border-radius: var(--radius);
    padding: 40px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .api-setup h2 { font-size: 1.5rem; margin-bottom: 8px; }
  .api-setup p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.6; }

  .api-setup input {
    width: 100%;
    padding: 11px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    margin-bottom: 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  .api-setup input:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }

  input[type="text"], input[type="password"], select, textarea {
    width: 100%;
    padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    outline: none;
    transition: border-color 0.15s;
    background: var(--surface);
    color: var(--text);
    font-family: inherit;
  }

  input:focus, select:focus, textarea:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.4);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  .spinner.dark {
    border-color: rgba(0,0,0,0.15);
    border-top-color: var(--accent);
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-state {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-muted);
  }

  .empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
  .empty-state h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; color: var(--text); }
  .empty-state p { font-size: 0.875rem; }

  /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
  .history-week {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .history-week h4 {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .history-meals {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 8px;
  }

  .history-meal-item {
    background: var(--surface2);
    border-radius: var(--radius-sm);
    padding: 8px;
    font-size: 0.78rem;
  }

  .history-meal-item .day-label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.7rem;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .toast {
    background: #1c1c1c;
    color: white;
    padding: 12px 18px;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    box-shadow: var(--shadow-lg);
    animation: toastIn 0.25s ease;
    max-width: 320px;
  }

  @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .toast.success { background: var(--accent-dark); }
  .toast.error { background: #dc2626; }

  /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .badge-green { background: var(--accent-light); color: var(--accent-dark); }
  .badge-yellow { background: #fef3e2; color: #b45309; }
  .badge-blue { background: #e8f4fd; color: #1d6f9e; }

  /* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
  .settings-bar {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    display: none;
  }

  .settings-bar.open { display: block; }
  .settings-bar h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 12px; }

  .settings-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .settings-row .form-group { margin-bottom: 0; flex: 1; min-width: 200px; }

  /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .week-grid {
      grid-template-columns: 70px repeat(7, 1fr);
      font-size: 0.75rem;
    }

    .grid-cell { padding: 4px; min-height: 60px; }
    .grid-header { padding: 6px 2px; }
    .day-name { font-size: 0.58rem; }
    .day-num { font-size: 0.85rem; }
    .grid-row-label { font-size: 0.58rem; padding: 4px 2px; min-height: 60px; }
    .grid-row-label .meal-pill { font-size: 0.5rem; padding: 3px 4px; }
    .meal-card-mini .meal-name { font-size: 0.68rem; }
    .meal-card-mini .meal-actions { display: none; }
    .servings-control .servings-label { display: none; }
    .meal-slot .add-btn { width: 22px; height: 22px; font-size: 0.85rem; }

    .recipe-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }

    .header-inner { gap: 12px; }
    nav button { padding: 6px 10px; font-size: 0.8rem; }
    .logo { font-size: 1rem; }
    .logo span { display: none; }
  }

  @media (max-width: 500px) {
    .week-grid {
      grid-template-columns: 58px repeat(7, 1fr);
    }
    .grocery-grid { grid-template-columns: 1fr; }
  }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }

  .tag {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 99px;
    font-size: 0.7rem;
    font-weight: 600;
    background: var(--surface2);
    color: var(--text-muted);
    margin: 2px;
  }

  .select-slot-hint {
    background: var(--accent-light);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 0.85rem;
    color: var(--accent-dark);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ai-generated-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.65rem;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 1px 6px;
    border-radius: 99px;
    margin-top: 2px;
  }

  /* ‚îÄ‚îÄ INGREDIENT CHECKLIST MODAL ‚îÄ‚îÄ */
  /* ‚îÄ‚îÄ RECIPE DETAIL MODAL ‚îÄ‚îÄ */
  .recipe-detail-modal {
    max-width: 900px;
  }

  #slot-modal {
    max-width: 560px;
  }

  .recipe-detail-hero {
    background: var(--surface2);
    border-radius: var(--radius) var(--radius) 0 0;
    padding: 28px 28px 20px;
    border-bottom: 1px solid var(--border);
  }

  .recipe-detail-title {
    font-size: 1.4rem;
    font-weight: 700;
    line-height: 1.25;
    color: var(--text);
    margin-bottom: 10px;
  }

  .recipe-detail-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .recipe-detail-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.78rem;
    color: var(--text-muted);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 99px;
    padding: 5px 12px;
  }

  .recipe-detail-chip.accent {
    background: var(--accent-light);
    border-color: var(--accent);
    color: var(--accent-dark);
    font-weight: 600;
  }

  .recipe-detail-body {
    padding: 24px 28px;
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 32px;
  }

  @media (max-width: 540px) {
    .recipe-detail-body {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  .recipe-detail-section-label {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .recipe-detail-ingredients {
    list-style: none;
  }

  .recipe-detail-ingredients li {
    font-size: 0.875rem;
    padding: 5px 0;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    line-height: 1.4;
  }

  .recipe-detail-ingredients li:last-child {
    border-bottom: none;
  }

  .recipe-detail-instructions {
    font-size: 0.875rem;
    line-height: 1.75;
    color: var(--text);
    white-space: pre-wrap;
  }

  .recipe-detail-instructions.numbered ol {
    padding-left: 20px;
  }

  .recipe-detail-instructions.numbered li {
    margin-bottom: 10px;
  }

  .recipe-detail-footer {
    padding: 14px 28px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
    background: var(--surface);
    border-radius: 0 0 var(--radius) var(--radius);
  }

  .recipe-detail-servings {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: var(--text-muted);
    flex: 1;
  }

  .recipe-detail-servings button {
    width: 26px; height: 26px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.12s;
  }

  .recipe-detail-servings button:hover { background: var(--border); }

  .recipe-detail-servings strong {
    font-size: 1rem;
    color: var(--text);
    min-width: 20px;
    text-align: center;
  }

  .servings-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--accent-light);
    border: 1px solid var(--accent);
    border-radius: 99px;
    padding: 3px 6px 3px 10px;
    font-size: 0.78rem;
    color: var(--accent-dark);
    font-weight: 600;
  }
  .servings-chip-btn {
    width: 20px; height: 20px;
    border-radius: 50%;
    border: 1px solid var(--accent);
    background: var(--surface);
    color: var(--accent-dark);
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 700;
    display: inline-flex; align-items: center; justify-content: center;
    line-height: 1;
    padding: 0;
    transition: background 0.12s;
    flex-shrink: 0;
  }
  .servings-chip-btn:hover { background: var(--accent); color: white; }

  /* Make meal name clickable */
  .meal-name-clickable {
    cursor: pointer;
    text-decoration: underline;
    text-decoration-color: transparent;
    text-underline-offset: 2px;
    transition: text-decoration-color 0.15s, color 0.15s;
  }

  .meal-slot:hover .meal-name-clickable {
    text-decoration-color: rgba(0,0,0,0.25);
  }

  .meal-name-clickable:hover {
    color: var(--accent-dark) !important;
    text-decoration-color: var(--accent) !important;
  }

  .ing-check-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 340px;
    overflow-y: auto;
    padding: 2px 0;
  }

  .ing-check-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.12s;
    user-select: none;
  }

  .ing-check-item:hover { background: var(--accent-light); }

  .ing-check-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
    cursor: pointer;
    flex-shrink: 0;
  }

  .ing-check-item span {
    font-size: 0.875rem;
    color: var(--text);
    cursor: pointer;
    flex: 1;
  }

  .ing-check-item.checked span {
    color: var(--text);
    font-weight: 700;
  }

  .ing-check-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .ing-check-controls button {
    font-size: 0.75rem;
    padding: 3px 10px;
    border: 1px solid var(--border);
    background: var(--surface);
    border-radius: 99px;
    cursor: pointer;
    color: var(--text-muted);
    transition: all 0.12s;
  }

  .ing-check-controls button:hover {
    background: var(--surface2);
    color: var(--text);
  }

  .ing-check-note {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-bottom: 14px;
    line-height: 1.4;
  }

  /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
  #auth-screen {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  #auth-screen.hidden { display: none; }

  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    padding: 40px 36px;
    width: 100%;
    max-width: 400px;
  }

  .auth-logo {
    text-align: center;
    margin-bottom: 28px;
  }

  .auth-logo-icon {
    font-size: 2.8rem;
    display: block;
    margin-bottom: 8px;
  }

  .auth-logo-title {
    font-size: 1.35rem;
    font-weight: 700;
    color: var(--text);
  }

  .auth-logo-sub {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .auth-form { display: flex; flex-direction: column; gap: 14px; }

  .auth-form label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
    display: block;
  }

  .auth-form input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
  }

  .auth-form input:focus { border-color: var(--accent); }

  .auth-submit {
    width: 100%;
    padding: 11px;
    border: none;
    border-radius: 99px;
    background: var(--accent);
    color: white;
    font-size: 0.925rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.15s;
    margin-top: 4px;
  }

  .auth-submit:hover { background: var(--accent-dark); }
  .auth-submit:disabled { opacity: 0.6; cursor: not-allowed; }

  .auth-toggle {
    text-align: center;
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 8px;
  }

  .auth-toggle a {
    color: var(--accent-dark);
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
  }

  .auth-toggle a:hover { text-decoration: underline; }

  .auth-error {
    background: #fef2f2;
    border: 1px solid #fca5a5;
    color: #dc2626;
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 0.82rem;
    display: none;
  }

  .auth-success {
    background: var(--accent-light);
    border: 1px solid var(--accent);
    color: var(--accent-dark);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 0.82rem;
    display: none;
  }

  .auth-forgot {
    text-align: right;
    font-size: 0.78rem;
    margin-top: -8px;
  }

  .auth-forgot a {
    color: var(--text-muted);
    cursor: pointer;
    text-decoration: none;
  }

  .auth-forgot a:hover { color: var(--accent-dark); text-decoration: underline; }

</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <span class="auth-logo-icon">ü•ó</span>
      <div class="auth-logo-title">Meal Planner</div>
      <div class="auth-logo-sub">Sign in to access your meal plan</div>
    </div>

    <div id="auth-error" class="auth-error"></div>
    <div id="auth-success" class="auth-success"></div>

    <div class="auth-form" id="auth-signin-form">
      <div>
        <label id="auth-email-label">Email</label>
        <input type="email" id="auth-email" placeholder="you@example.com" autocomplete="email" onkeydown="if(event.key==='Enter')authSubmit()" />
      </div>
      <div id="auth-password-group">
        <label>Password</label>
        <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')authSubmit()" />
      </div>
      <div class="auth-forgot" id="auth-forgot-row">
        <a onclick="authForgotPassword()">Forgot password?</a>
      </div>
      <button class="auth-submit" id="auth-submit-btn" onclick="authSubmit()">Sign in</button>
    </div>

    <div class="auth-toggle" id="auth-toggle">
      Don't have an account? <a onclick="authToggleMode()">Sign up</a>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="header-inner">
    <div class="logo"><span>ü•ó</span> Meal Planner</div>
    <nav>
      <button id="nav-week" class="active" onclick="switchView('week')">This Week</button>
      <button id="nav-recipes" onclick="switchView('recipes')">Recipes</button>
    </nav>
    <div class="header-actions">
      <div id="sync-status" class="sync-status" title="Sync not configured">
        <span class="sync-dot"></span>
        <span class="sync-label" id="sync-label">Not synced</span>
      </div>
      <button class="btn-icon" id="sync-now-btn" title="Sync now" onclick="manualSync()" style="display:none;">‚Üª</button>
      <button class="btn-icon" title="Settings" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>
  </div>
</header>

<!-- SETTINGS BAR -->
<div style="max-width:1200px;margin:0 auto;padding:0 20px;">
  <div id="settings-bar" class="settings-bar">
    <h3>‚öôÔ∏è Settings</h3>

    <!-- API Key for recipe import -->
    <div class="settings-row" style="margin-bottom:12px;">
      <div class="form-group" style="flex:2;min-width:280px;">
        <label>Anthropic API Key <span style="font-weight:400;color:var(--text-muted);">(for URL &amp; photo recipe import)</span></label>
        <input type="password" id="settings-api-key" placeholder="sk-ant-..." />
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end;">
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
      </div>
    </div>

    <!-- Todoist section -->
    <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <span style="font-size:0.8rem;font-weight:700;">‚úÖ Todoist</span>
        <span style="font-size:0.75rem;color:var(--text-muted);">‚Äî export grocery list directly to Todoist</span>
        <a href="https://app.todoist.com/app/settings/integrations/developer" target="_blank" rel="noopener" style="font-size:0.72rem;color:var(--accent-dark);text-decoration:none;margin-left:auto;">Get API token ‚Üó</a>
      </div>
      <div class="settings-row">
        <div class="form-group" style="flex:2;min-width:280px;">
          <label>Todoist API Token <span style="font-weight:400;color:var(--text-muted);">(your own, private ‚Äî never synced)</span></label>
          <input type="password" id="settings-todoist-key" placeholder="Paste your API token‚Ä¶" />
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end;">
          <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </div>
      </div>
    </div>

    <!-- Account section -->
    <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <span style="font-size:0.8rem;font-weight:700;">üë§ Account</span>
        <span id="settings-user-email" style="font-size:0.78rem;color:var(--text-muted);margin-left:8px;"></span>
      </div>
      <button class="btn btn-danger btn-sm" onclick="signOut()">Sign out</button>
    </div>
  </div>
</div>

<main>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEK VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="view-week" class="view active">

    <div id="week-content">
      <div class="week-header">
        <div>
          <div class="week-title" id="week-title">This Week</div>
          <div class="week-subtitle" id="week-subtitle"></div>
        </div>
        <div class="week-actions">
          <button class="btn btn-ghost btn-sm" onclick="saveWeekToHistory()" title="Save to History">üíæ Save</button>
          <button class="btn btn-ghost btn-sm" onclick="clearWeek()" title="Clear this week" style="color:var(--text-muted);">üóë Clear</button>
        </div>
      </div>

      <!-- WEEK TABS -->
      <div class="week-tabs">
        <button id="week-tab-0" class="week-tab active" onclick="switchWeek(0)">This Week</button>
        <button id="week-tab-1" class="week-tab" onclick="switchWeek(1)">Next Week</button>
      </div>

      <!-- WEEK GRID -->
      <div class="week-grid" id="week-grid"></div>

      <!-- GROCERY LIST -->
      <div class="divider"></div>
      <div class="section-header">
        <div class="section-title">üõí Grocery List</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="copyGroceryList()">üìã Copy list</button>
          <button class="btn btn-secondary btn-sm" onclick="exportToTodoist()">‚úÖ Send to Todoist</button>
          <button class="btn btn-secondary btn-sm" onclick="uncheckAll()">‚Ü∫ Uncheck all</button>
        </div>
      </div>
      <div id="grocery-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECIPES VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="view-recipes" class="view">
    <div class="recipes-header">
      <div>
        <h2 style="font-size:1.4rem;font-weight:700;">Recipes</h2>
      </div>
    </div>

    <div class="recipe-tabs">
      <button class="recipe-tab active" id="rtab-mine" onclick="switchRecipeTab('mine')">üìù My Recipes</button>
      <button class="recipe-tab" id="rtab-favorites" onclick="switchRecipeTab('favorites')">‚≠ê Favorites</button>
      <button class="recipe-tab" id="rtab-history" onclick="switchRecipeTab('history')">üìÖ History</button>
    </div>

    <!-- MY RECIPES TAB -->
    <div id="rtab-content-mine">

      <!-- Photo Import -->
      <div style="background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow);">
        <h3 style="font-size:0.95rem;font-weight:700;margin-bottom:6px;">üì∑ Import from Photo</h3>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">Take a photo of a cookbook recipe (up to 3 pages). Requires an Anthropic API key.</p>
        <!-- Hidden file input -->
        <input type="file" id="photo-file-input" accept="image/*" style="display:none;" onchange="addPhotoFiles(this.files)" />
        <!-- Drop / tap zone -->
        <div id="photo-dropzone" class="photo-dropzone" onclick="document.getElementById('photo-file-input').click()">
          <div class="photo-dropzone-icon">üì∑</div>
          <div class="photo-dropzone-text">Tap to take a photo or choose from library</div>
          <div class="photo-dropzone-sub">JPEG, PNG, HEIC ‚Äî up to 3 photos</div>
        </div>
        <!-- Thumbnails -->
        <div id="photo-thumbnails" class="photo-thumbnails"></div>
        <!-- Actions -->
        <div style="display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap;">
          <button class="btn btn-primary" id="photo-parse-btn" onclick="parsePhotosWithClaude()" style="display:none;">‚ú® Parse Recipe</button>
          <button class="btn btn-secondary btn-sm" id="photo-add-btn" onclick="document.getElementById('photo-file-input').click()" style="display:none;">+ Add another photo</button>
          <button class="btn btn-ghost btn-sm" id="photo-clear-btn" onclick="initPhotoImport()" style="display:none;">‚úï Clear all</button>
        </div>
        <div id="photo-import-status" style="margin-top:10px;font-size:0.82rem;color:var(--text-muted);"></div>
      </div>

      <!-- URL Import -->
      <div style="background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow);">
        <h3 style="font-size:0.95rem;font-weight:700;margin-bottom:12px;">üîó Import from URL</h3>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">Paste any recipe page URL and we'll extract the recipe. Requires an Anthropic API key.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <input type="url" id="url-import-input" placeholder="https://www.allrecipes.com/recipe/‚Ä¶" style="flex:1;min-width:200px;" />
          <button class="btn btn-primary" onclick="importFromUrl()">üì• Import</button>
        </div>
        <div id="url-import-status" style="margin-top:10px;font-size:0.82rem;color:var(--text-muted);"></div>
      </div>

      <!-- Manual Recipe Form -->
      <div style="background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow);" id="recipe-form-card">
        <h3 style="font-size:0.95rem;font-weight:700;margin-bottom:16px;" id="recipe-form-title">‚úèÔ∏è Create a Recipe</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="form-group" style="grid-column:1/-1;">
            <label>Recipe Name *</label>
            <input type="text" id="new-recipe-name" placeholder="e.g. Mom's Chicken Soup" />
          </div>
          <div class="form-group">
            <label>Prep / Cook Time</label>
            <input type="text" id="new-recipe-time" placeholder="e.g. 30 min" />
          </div>
          <div class="form-group">
            <label>Default Servings
              <span style="font-weight:400;color:var(--text-muted);font-size:0.78rem;display:block;margin-top:1px;">Ingredients are stored per 1 serving</span>
            </label>
            <input type="number" id="new-recipe-servings" placeholder="e.g. 4" min="1" max="99" />
          </div>
          <div class="form-group">
            <label>Source URL (optional)</label>
            <input type="url" id="new-recipe-url" placeholder="https://‚Ä¶" />
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>Ingredients <span style="font-weight:400;color:var(--text-muted);">(per 1 serving ‚Äî scaled automatically)</span></label>
            <div class="ing-builder" id="new-recipe-ing-builder">
              <div class="ing-builder-header">
                <span>Qty</span><span>Unit</span><span>Ingredient</span><span></span>
              </div>
              <div id="new-recipe-ing-rows"></div>
            </div>
            <div class="ing-add-row" style="margin-top:0;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);background:var(--surface2);padding:6px 8px;">
              <button class="btn btn-ghost btn-sm" onclick="addIngRow('new-recipe-ing-rows')" style="padding:4px 10px;">+ Add ingredient</button>
            </div>
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>Notes / Instructions (optional)</label>
            <textarea id="new-recipe-notes" rows="5" placeholder="Any notes about preparation‚Ä¶"></textarea>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:4px;">
          <button class="btn btn-primary" id="recipe-save-btn" onclick="saveCustomRecipe()">üíæ Save Recipe</button>
          <button class="btn btn-secondary" id="recipe-cancel-edit-btn" onclick="cancelEditRecipe()" style="display:none;">Cancel</button>
        </div>
      </div>

      <!-- Saved Custom Recipes -->
      <div id="custom-recipes-grid" class="recipe-grid"></div>
    </div>

    <div id="rtab-content-favorites" style="display:none;">
      <div id="favorites-grid" class="recipe-grid"></div>
    </div>

    <div id="rtab-content-history" style="display:none;">
      <div id="history-list"></div>
    </div>
  </div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SLOT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="slot-overlay" class="overlay" onclick="closeSlotModal(event)">
  <div class="modal" id="slot-modal">
    <div class="modal-header">
      <div class="modal-title" id="slot-modal-title">Choose a Meal</div>
      <button class="close-btn" onclick="closeSlotModal(null, true)">‚úï</button>
    </div>
    <div class="modal-body">
      <button class="slot-back-btn" id="slot-back-btn" onclick="showSlotPanel('home')">‚Üê Back</button>

      <!-- ‚îÄ‚îÄ PANEL: HOME ‚îÄ‚îÄ -->
      <div class="slot-panel active" id="slot-panel-home">
        <button class="slot-choice-card" onclick="showSlotPanel('meal')">
          <div class="slot-choice-icon">üçΩ</div>
          <div>
            <div class="slot-choice-label">Add a Meal</div>
            <div class="slot-choice-sub">Quick entry ‚Äî name and ingredients</div>
          </div>
        </button>
        <button class="slot-choice-card" onclick="showSlotPanel('recipe')">
          <div class="slot-choice-icon">üìñ</div>
          <div>
            <div class="slot-choice-label">Add a New Recipe</div>
            <div class="slot-choice-sub">Import from photo or URL, or create manually ‚Äî saves to My Recipes</div>
          </div>
        </button>
        <button class="slot-choice-card" onclick="showSlotPanel('existing'); renderSlotPopular(); renderSlotSavedList();">
          <div class="slot-choice-icon">‚≠ê</div>
          <div>
            <div class="slot-choice-label">Select from Existing</div>
            <div class="slot-choice-sub">My Recipes, Favorites, or search</div>
          </div>
        </button>
      </div>

      <!-- ‚îÄ‚îÄ PANEL: ADD A MEAL ‚îÄ‚îÄ -->
      <div class="slot-panel" id="slot-panel-meal">
        <div class="form-group">
          <label>Meal Name</label>
          <div style="display:flex;gap:8px;">
            <input type="text" id="slot-manual-input" placeholder="e.g. Pasta Bolognese, Grilled Salmon‚Ä¶"
              onkeydown="if(event.key==='Enter') addManualMeal()" style="flex:1;" />
            <button class="btn btn-primary" onclick="addManualMeal()">+ Add</button>
          </div>
        </div>
        <label style="display:inline-flex;align-items:center;gap:7px;font-size:0.8rem;color:var(--text-muted);cursor:pointer;margin-bottom:12px;">
          <input type="checkbox" id="slot-save-recipe-checkbox" style="width:14px;height:14px;accent-color:var(--accent);cursor:pointer;" />
          Save as a new recipe
        </label>
        <div class="form-group" style="margin-bottom:0;">
          <label>Ingredients per 1 serving (optional)</label>
          <div class="ing-builder">
            <div class="ing-builder-header"><span>Qty</span><span>Unit</span><span>Ingredient</span><span></span></div>
            <div id="slot-ing-rows"></div>
          </div>
          <div style="border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);background:var(--surface2);padding:6px 8px;">
            <button class="btn btn-ghost btn-sm" onclick="addIngRow('slot-ing-rows')" style="padding:4px 10px;">+ Add ingredient</button>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ PANEL: ADD A NEW RECIPE ‚îÄ‚îÄ -->
      <div class="slot-panel" id="slot-panel-recipe">
        <!-- Photo import -->
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;margin-bottom:14px;border:1px solid var(--border);">
          <div style="font-size:0.85rem;font-weight:700;margin-bottom:8px;">üì∑ Import from Photo</div>
          <input type="file" id="slot-photo-file-input" accept="image/*" style="display:none;" onchange="addSlotPhotoFiles(this.files)" />
          <div id="slot-photo-dropzone" class="photo-dropzone" style="padding:16px 12px;" onclick="document.getElementById('slot-photo-file-input').click()">
            <div class="photo-dropzone-icon">üì∑</div>
            <div class="photo-dropzone-text" style="font-size:0.82rem;">Tap to choose a photo</div>
            <div class="photo-dropzone-sub">JPEG, PNG, HEIC ‚Äî up to 3</div>
          </div>
          <div id="slot-photo-thumbnails" class="photo-thumbnails"></div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm" id="slot-photo-parse-btn" onclick="parseSlotPhotosWithClaude()" style="display:none;">‚ú® Parse Recipe</button>
            <button class="btn btn-secondary btn-sm" id="slot-photo-add-btn" onclick="document.getElementById('slot-photo-file-input').click()" style="display:none;">+ Add photo</button>
            <button class="btn btn-ghost btn-sm" id="slot-photo-clear-btn" onclick="initSlotPhotoImport()" style="display:none;">‚úï Clear</button>
          </div>
          <div id="slot-photo-import-status" style="margin-top:8px;font-size:0.8rem;color:var(--text-muted);"></div>
        </div>
        <!-- URL import -->
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;margin-bottom:14px;border:1px solid var(--border);">
          <div style="font-size:0.85rem;font-weight:700;margin-bottom:8px;">üîó Import from URL</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <input type="url" id="slot-url-import-input" placeholder="https://www.allrecipes.com/recipe/‚Ä¶" style="flex:1;min-width:160px;" />
            <button class="btn btn-primary btn-sm" onclick="importFromUrlSlot()">üì• Import</button>
          </div>
          <div id="slot-url-import-status" style="margin-top:8px;font-size:0.8rem;color:var(--text-muted);"></div>
        </div>
        <!-- Manual form -->
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border);">
          <div style="font-size:0.85rem;font-weight:700;margin-bottom:12px;">‚úèÔ∏è Manual Entry</div>
          <div class="form-group">
            <label>Recipe Name *</label>
            <input type="text" id="slot-recipe-name" placeholder="e.g. Mom's Chicken Soup" />
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group">
              <label>Prep / Cook Time</label>
              <input type="text" id="slot-recipe-time" placeholder="e.g. 30 min" />
            </div>
            <div class="form-group">
              <label>Default Servings</label>
              <input type="number" id="slot-recipe-servings" placeholder="e.g. 4" min="1" max="99" />
            </div>
          </div>
          <div class="form-group">
            <label>Source URL (optional)</label>
            <input type="url" id="slot-recipe-url" placeholder="https://‚Ä¶" />
          </div>
          <div class="form-group">
            <label>Ingredients <span style="font-weight:400;color:var(--text-muted);">(per 1 serving)</span></label>
            <div class="ing-builder">
              <div class="ing-builder-header"><span>Qty</span><span>Unit</span><span>Ingredient</span><span></span></div>
              <div id="slot-recipe-ing-rows"></div>
            </div>
            <div style="border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);background:var(--surface);padding:6px 8px;">
              <button class="btn btn-ghost btn-sm" onclick="addIngRow('slot-recipe-ing-rows')" style="padding:4px 10px;">+ Add ingredient</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label>Notes / Instructions (optional)</label>
            <textarea id="slot-recipe-notes" rows="4" placeholder="Step-by-step instructions‚Ä¶"></textarea>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="saveAndAddRecipeFromSlot()">üíæ Save & Add to Plan</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ PANEL: SELECT FROM EXISTING ‚îÄ‚îÄ -->
      <div class="slot-panel" id="slot-panel-existing">
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input type="text" id="slot-search-input" placeholder="Search saved recipes‚Ä¶"
            onkeydown="if(event.key==='Enter') slotSearch()" style="flex:1;" />
          <button class="btn btn-secondary" onclick="slotSearch()">Search</button>
        </div>
        <div id="slot-results" style="margin-bottom:12px;"></div>
        <div class="slot-section-label">Popular</div>
        <div id="slot-popular-list" style="margin-bottom:14px;"></div>
        <div style="display:flex;gap:2px;margin-bottom:10px;border-bottom:2px solid var(--border);">
          <button class="slot-pick-tab active" id="spick-tab-mine" onclick="switchSlotPickTab('mine')"
            style="padding:6px 12px;border:none;background:none;cursor:pointer;font-size:0.8rem;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all 0.15s;">
            üìù My Recipes
          </button>
          <button class="slot-pick-tab" id="spick-tab-favs" onclick="switchSlotPickTab('favs')"
            style="padding:6px 12px;border:none;background:none;cursor:pointer;font-size:0.8rem;font-weight:600;color:var(--text-muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all 0.15s;">
            ‚≠ê Favorites
          </button>
        </div>
        <div id="slot-saved-list" style="max-height:220px;overflow-y:auto;"></div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DROP ACTION MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="drop-action-overlay" class="overlay" onclick="cancelDropAction(event)">
  <div class="modal" style="max-width:340px;">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="drop-action-title">Move or Duplicate?</div>
        <div id="drop-action-subtitle" style="font-size:0.82rem;color:var(--text-muted);margin-top:2px;"></div>
      </div>
      <button class="close-btn" onclick="cancelDropAction(null, true)">‚úï</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:10px;padding-top:8px;">
      <button class="btn btn-primary" style="justify-content:flex-start;gap:10px;padding:12px 16px;" onclick="confirmDropAction('move')">
        <span style="font-size:1.1rem;">‚ÜóÔ∏è</span>
        <span><strong>Move</strong> ‚Äî remove from original slot</span>
      </button>
      <button class="btn btn-secondary" style="justify-content:flex-start;gap:10px;padding:12px 16px;" onclick="confirmDropAction('duplicate')">
        <span style="font-size:1.1rem;">üìã</span>
        <span><strong>Duplicate</strong> ‚Äî keep in original slot too</span>
      </button>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="cancelDropAction(null, true)">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD TO PLAN MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="addplan-overlay" class="overlay" onclick="closeAddPlanModal(event)">
  <div class="modal" style="max-width:360px;">
    <div class="modal-header">
      <div class="modal-title">Add to Plan</div>
      <button class="close-btn" onclick="closeAddPlanModal(null, true)">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="addplan-recipe-name" style="font-weight:600;margin-bottom:16px;"></div>
      <div class="form-group">
        <label>Day</label>
        <select id="addplan-day">
          <option value="0">Saturday</option>
          <option value="1">Sunday</option>
          <option value="2">Monday</option>
          <option value="3">Tuesday</option>
          <option value="4">Wednesday</option>
          <option value="5">Thursday</option>
          <option value="6">Friday</option>
        </select>
      </div>
      <div class="form-group">
        <label>Meal</label>
        <select id="addplan-meal">
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="snacks">Snacks</option>
          <option value="dinner">Dinner</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddPlanModal(null, true)">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddToPlan()">Add to Plan</button>
    </div>
  </div>
</div>

<!-- Recipe Detail Modal -->
<div id="recipe-detail-overlay" class="overlay" onclick="closeRecipeDetail(event)">
  <div class="modal recipe-detail-modal">
    <div class="modal-header" style="padding:16px 20px 14px;">
      <div style="font-size:0.75rem;font-weight:600;color:var(--text-muted);letter-spacing:0.05em;text-transform:uppercase;" id="recipe-detail-slot-label"></div>
      <button class="close-btn" onclick="closeRecipeDetail(null,true)">‚úï</button>
    </div>
    <div class="recipe-detail-hero">
      <div class="recipe-detail-title" id="recipe-detail-title"></div>
      <div class="recipe-detail-meta" id="recipe-detail-meta"></div>
    </div>
    <div class="recipe-detail-body" id="recipe-detail-body">
      <!-- filled by JS -->
    </div>
    <div class="recipe-detail-footer" style="flex-wrap:wrap;gap:12px;">
      <div style="display:flex;align-items:center;gap:16px;flex:1;flex-wrap:wrap;">
        <div class="recipe-detail-servings" style="flex:none;">
          <span style="font-size:0.72rem;font-weight:600;color:var(--accent-dark);text-transform:uppercase;letter-spacing:0.04em;white-space:nowrap;">Cooking for</span>
          <button onclick="recipeDetailChangeCookServings(-1)" title="View ingredients for fewer servings">‚àí</button>
          <strong id="recipe-detail-cook-count" style="color:var(--accent-dark);">1</strong>
          <button onclick="recipeDetailChangeCookServings(1)" title="View ingredients for more servings">+</button>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
        <a id="recipe-detail-url-btn" class="btn btn-secondary btn-sm" target="_blank" rel="noopener" style="display:none;">üîó View original</a>
        <button class="btn btn-secondary btn-sm" onclick="openSlotModalFromDetail()">‚úèÔ∏è Edit slot</button>
      </div>
    </div>
  </div>
</div>

<!-- Ingredient Checklist Modal -->
<div id="ing-check-overlay" class="overlay" onclick="closeIngCheckModal(event)">
  <div class="modal" style="max-width:460px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">üõí Add to Grocery List?</div>
        <div id="ing-check-subtitle" style="font-size:0.8rem;color:var(--text-muted);margin-top:2px;"></div>
      </div>
      <button class="close-btn" onclick="closeIngCheckModal(null, true)">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="ing-check-note">Check the ingredients you need to buy. Unchecked items won't be added to your grocery list. The meal will be added to your plan either way.</p>
      <div class="ing-check-controls">
        <button onclick="ingCheckToggleAll(true)">Check all</button>
        <button onclick="ingCheckToggleAll(false)">Uncheck all</button>
      </div>
      <div class="ing-check-list" id="ing-check-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeIngCheckModal(null, true)">Cancel</button>
      <button class="btn btn-primary" onclick="confirmIngCheck()">Add to Plan</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const DAYS = ['Saturday','Sunday','Monday','Tuesday','Wednesday','Thursday','Friday'];
const MEALS = ['breakfast','lunch','snacks','dinner'];
const MEAL_EMOJIS = { breakfast: '‚òÄÔ∏è', lunch: 'üå§', snacks: 'üçé', dinner: 'üåô' };

const GROCERY_CATEGORIES = {
  produce: { label: 'Produce', emoji: 'ü•¶', keywords: ['tomato','lettuce','spinach','kale','arugula','carrot','celery','onion','garlic','ginger','pepper','cucumber','zucchini','eggplant','broccoli','cauliflower','asparagus','mushroom','corn','pea','bean','lemon','lime','orange','apple','banana','berry','blueberry','strawberry','raspberry','avocado','mango','pineapple','grape','herbs','basil','parsley','cilantro','mint','dill','thyme','rosemary','sage','chive','scallion','leek','shallot','potato','sweet potato','yam','beet','radish','artichoke','cabbage','bok choy','fennel','squash','pumpkin','butternut','romaine','arugula','endive'] },
  meat: { label: 'Meat & Seafood', emoji: 'ü•©', keywords: ['chicken','beef','pork','lamb','turkey','duck','salmon','tuna','shrimp','cod','tilapia','halibut','steak','ground beef','sausage','bacon','ham','prosciutto','pancetta','anchovy','crab','lobster','scallop','mussel','oyster','clam','sardine','fish','seafood','meat'] },
  dairy: { label: 'Dairy & Eggs', emoji: 'üßÄ', keywords: ['milk','cream','butter','cheese','cheddar','mozzarella','parmesan','feta','brie','gouda','ricotta','yogurt','sour cream','cream cheese','egg','eggs','half-and-half','ghee','whey'] },
  grains: { label: 'Grains & Bread', emoji: 'üçû', keywords: ['bread','flour','pasta','rice','noodle','tortilla','pita','baguette','roll','oat','quinoa','barley','farro','couscous','polenta','grits','crouton','breadcrumb','panko','cereal','granola','muffin','bagel','croissant','wrap','bun'] },
  canned: { label: 'Canned & Dry Goods', emoji: 'ü•´', keywords: ['can','canned','beans','lentil','chickpea','tomato sauce','tomato paste','tomato puree','broth','stock','coconut milk','olive oil','oil','vinegar','soy sauce','hot sauce','worcestershire','mustard','ketchup','mayo','mayonnaise','honey','syrup','jam','jelly','nut butter','peanut butter','almond butter','salt','pepper','spice','herb','cumin','paprika','turmeric','coriander','cinnamon','vanilla','baking','sugar','brown sugar','flour','cornstarch','baking powder','baking soda','chocolate','cocoa','dried','raisin','nut','almond','walnut','cashew','peanut','pecan','pistachio','seed','sesame','sunflower','flaxseed','coconut','lentils','split pea','curry paste','miso','tahini','sriracha'] },
  frozen: { label: 'Frozen', emoji: 'üßä', keywords: ['frozen','ice cream','ice','popsicle'] },
  other: { label: 'Other', emoji: 'üõí', keywords: [] }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _supabase = null;      // Supabase client instance
let _currentUser = null;   // Current authenticated user
let _authMode = 'signin';  // 'signin' | 'signup' | 'reset'
let _pushTimer = null;
let _pollTimer = null;

const SUPABASE_URL = 'https://llnaluqrczhwldhrbxzj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsbmFsdXFyY3pod2xkaHJieHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIzMjM0MTYsImV4cCI6MjA4Nzg5OTQxNn0.l_rvffuIaooUOk-Zo7ueMngrldyx3_VWDS0r8zogqLE';

function initSupabase() {
  try {
    _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return true;
  } catch(e) {
    _supabase = null;
    return false;
  }
}


function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('auth-success').style.display = 'none';
}

function clearAuthMessages() {
  const e = document.getElementById('auth-error');
  const s = document.getElementById('auth-success');
  if (e) e.style.display = 'none';
  if (s) s.style.display = 'none';
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('auth-error').style.display = 'none';
}

function authToggleMode() {
  _authMode = _authMode === 'signin' ? 'signup' : 'signin';
  const btn = document.getElementById('auth-submit-btn');
  const toggle = document.getElementById('auth-toggle');
  const forgotRow = document.getElementById('auth-forgot-row');
  const pwGroup = document.getElementById('auth-password-group');
  clearAuthMessages();
  if (_authMode === 'signup') {
    btn.textContent = 'Create account';
    toggle.innerHTML = 'Already have an account? <a onclick="authToggleMode()">Sign in</a>';
    if (forgotRow) forgotRow.style.display = 'none';
  } else {
    btn.textContent = 'Sign in';
    toggle.innerHTML = "Don't have an account? <a onclick=\"authToggleMode()\">Sign up</a>";
    if (forgotRow) forgotRow.style.display = '';
    if (pwGroup) pwGroup.style.display = '';
  }
}

async function authSubmit() {
  if (!_supabase) { showAuthError('Supabase is not configured. Please enter your Project URL and Anon Key above.'); return; }
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const btn = document.getElementById('auth-submit-btn');

  if (!email) { showAuthError('Please enter your email.'); return; }
  if (_authMode !== 'reset' && !password) { showAuthError('Please enter your password.'); return; }

  btn.disabled = true;
  btn.textContent = _authMode === 'signup' ? 'Creating account‚Ä¶' : 'Signing in‚Ä¶';
  clearAuthMessages();

  try {
    if (_authMode === 'signup') {
      const { data, error } = await _supabase.auth.signUp({ email, password });
      if (error) throw error;
      if (data.user && data.session) {
        await onAuthSuccess(data.session);
      } else {
        showAuthSuccess('Account created! Check your email to confirm, then sign in.');
        _authMode = 'signin';
        btn.textContent = 'Sign in';
      }
    } else {
      const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      await onAuthSuccess(data.session);
    }
  } catch(e) {
    showAuthError(e.message || 'Authentication failed.');
    btn.disabled = false;
    btn.textContent = _authMode === 'signup' ? 'Create account' : 'Sign in';
  }
}

async function authForgotPassword() {
  if (!_supabase) { showAuthError('Supabase is not configured.'); return; }
  const email = document.getElementById('auth-email').value.trim();
  if (!email) { showAuthError('Enter your email address first.'); return; }
  clearAuthMessages();
  try {
    const { error } = await _supabase.auth.resetPasswordForEmail(email);
    if (error) throw error;
    showAuthSuccess('Password reset email sent! Check your inbox.');
  } catch(e) {
    showAuthError(e.message || 'Failed to send reset email.');
  }
}

async function onAuthSuccess(session) {
  _currentUser = session.user;
  // Hide auth screen
  document.getElementById('auth-screen').classList.add('hidden');
  // Update settings panel email display
  const emailEl = document.getElementById('settings-user-email');
  if (emailEl) emailEl.textContent = _currentUser.email || '';
  // Load data from Supabase, then render
  await pullFromCloud();
  renderWeekGrid();
  renderGroceryList();
  // Start poll
  if (_pollTimer) clearInterval(_pollTimer);
  _pollTimer = setInterval(pullFromCloud, 30000);
  setSyncStatus('synced', `Signed in as ${_currentUser.email}`);
  const syncBtn = document.getElementById('sync-now-btn');
  if (syncBtn) syncBtn.style.display = '';
}

async function signOut() {
  if (_supabase) await _supabase.auth.signOut();
  _currentUser = null;
  if (_pollTimer) clearInterval(_pollTimer);
  if (_pushTimer) clearTimeout(_pushTimer);
  setSyncStatus('', 'Not signed in');
  const syncBtn = document.getElementById('sync-now-btn');
  if (syncBtn) syncBtn.style.display = 'none';
  // Show auth screen
  document.getElementById('auth-screen').classList.remove('hidden');
  clearAuthMessages();
  toggleSettings(); // close settings bar if open
  toast('Signed out', 'success');
}

// ‚îÄ‚îÄ Cloud sync helpers ‚îÄ‚îÄ

function getSharedData() {
  return {
    plans: state.plans,
    favorites: state.favorites,
    history: state.history,
    customRecipes: state.customRecipes,
    groceryChecked: state.groceryChecked,
    _updatedAt: Date.now(),
  };
}

function setSyncStatus(status, label) {
  const el = document.getElementById('sync-status');
  const lb = document.getElementById('sync-label');
  if (!el) return;
  el.className = 'sync-status' + (status ? ' ' + status : '');
  el.title = label;
  if (lb) lb.textContent = label;
}

function relativeTime(ts) {
  if (!ts) return 'never';
  const diff = Math.round((Date.now() - ts) / 1000);
  if (diff < 10) return 'just now';
  if (diff < 60) return `${diff}s ago`;
  if (diff < 3600) return `${Math.round(diff / 60)}m ago`;
  return `${Math.round(diff / 3600)}h ago`;
}

async function pushToCloud() {
  if (!_supabase || !_currentUser) return;
  setSyncStatus('syncing', 'Syncing‚Ä¶');
  try {
    const payload = {
      user_id: _currentUser.id,
      data: getSharedData(),
      updated_at: new Date().toISOString(),
    };
    const { error } = await _supabase
      .from('meal_planner_data')
      .upsert(payload, { onConflict: 'user_id' });
    if (error) throw error;
    state.lastSyncedAt = Date.now();
    const raw = JSON.parse(localStorage.getItem('mealplanner') || '{}');
    raw.lastSyncedAt = state.lastSyncedAt;
    localStorage.setItem('mealplanner', JSON.stringify(raw));
    setSyncStatus('synced', `Synced ${relativeTime(state.lastSyncedAt)}`);
  } catch(e) {
    setSyncStatus('error', `Sync error: ${e.message}`);
  }
}

async function pullFromCloud() {
  if (!_supabase || !_currentUser) return;
  try {
    const { data, error } = await _supabase
      .from('meal_planner_data')
      .select('data, updated_at')
      .eq('user_id', _currentUser.id)
      .single();

    if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows
    if (!data) return; // first time ‚Äî no data yet

    const remote = data.data;
    const remoteTs = remote._updatedAt || new Date(data.updated_at).getTime() || 0;
    if (remoteTs <= state.lastSyncedAt) {
      setSyncStatus('synced', `Synced ${relativeTime(state.lastSyncedAt)}`);
      return;
    }

    // Apply remote data
    if (remote.plans) {
      state.plans = remote.plans;
    } else if (remote.plan) {
      state.plans = { 0: remote.plan, 1: state.plans[1] || {} };
    }
    // Migrate single-object slots to arrays
    [0, 1].forEach(w => {
      if (!state.plans[w]) state.plans[w] = {};
      Object.keys(state.plans[w]).forEach(slotKey => {
        const val = state.plans[w][slotKey];
        if (val && !Array.isArray(val)) state.plans[w][slotKey] = [val];
      });
    });
    state.plan          = state.plans[state.weekOffset];
    state.favorites     = remote.favorites     || state.favorites;
    state.history       = remote.history       || state.history;
    state.customRecipes = remote.customRecipes || state.customRecipes;
    state.groceryChecked= remote.groceryChecked|| state.groceryChecked;
    state.lastSyncedAt  = remoteTs;

    // Persist locally
    const raw = JSON.parse(localStorage.getItem('mealplanner') || '{}');
    Object.assign(raw, {
      plans: state.plans, favorites: state.favorites, history: state.history,
      customRecipes: state.customRecipes, groceryChecked: state.groceryChecked,
      lastSyncedAt: state.lastSyncedAt,
    });
    localStorage.setItem('mealplanner', JSON.stringify(raw));

    // Re-render
    renderWeekGrid();
    renderGroceryList();
    renderFavorites();
    renderCustomRecipes();
    renderHistory();
    setSyncStatus('synced', `Synced ${relativeTime(state.lastSyncedAt)}`);
  } catch(e) {
    setSyncStatus('error', `Sync error: ${e.message}`);
  }
}

function schedulePush() {
  if (!_supabase || !_currentUser) return;
  clearTimeout(_pushTimer);
  _pushTimer = setTimeout(pushToCloud, 3000);
  setSyncStatus('syncing', 'Pending‚Ä¶');
}

async function manualSync() {
  if (!_supabase || !_currentUser) {
    toast('Sign in to sync', 'error');
    return;
  }
  const btn = document.getElementById('sync-now-btn');
  if (btn) { btn.style.opacity = '0.5'; btn.style.pointerEvents = 'none'; }
  await pullFromCloud();
  await pushToCloud();
  if (btn) { btn.style.opacity = ''; btn.style.pointerEvents = ''; }
}

let state = {
  plans: { 0: {}, 1: {} }, // 0 = this week, 1 = next week
  plan: {},  // pointer to plans[weekOffset] ‚Äî set in loadFromStorage
  weekOffset: 0, // 0 = this week, 1 = next week
  favorites: [],
  history: [],
  customRecipes: [],
  groceryChecked: {},
  searchResults: [],
  pendingAddRecipe: null,
  currentSlot: null, // { day, meal }
  currentView: 'week',
  currentRecipeTab: 'mine',
  apiKey: '',
  lastSyncedAt: 0,
  // Integrations
  todoistKey: '',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
  loadFromStorage();
  updateWeekTitle();
  // Init ingredient builders
  initIngBuilder('new-recipe-ing-rows');
  initIngBuilder('slot-ing-rows');
  initIngBuilder('slot-recipe-ing-rows');

  // Initialize Supabase and check for existing session
  initSupabase();

  // Check for existing session (e.g. page refresh)
  const { data: { session } } = await _supabase.auth.getSession();
  if (session) {
    await onAuthSuccess(session);
  }
  // If no session, auth screen stays visible (default)

  // Listen for auth changes (e.g. email confirmation link clicked)
  _supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session && !_currentUser) {
      await onAuthSuccess(session);
    } else if (event === 'SIGNED_OUT') {
      _currentUser = null;
    }
  });
}

function loadFromStorage() {
  try {
    const saved = JSON.parse(localStorage.getItem('mealplanner') || '{}');
    // Multi-week support: migrate old single-plan format if needed
    if (saved.plans) {
      state.plans = saved.plans;
    } else {
      state.plans = { 0: saved.plan || {}, 1: {} };
    }
    // Migrate any single-object slots to arrays (multi-recipe support)
    [0, 1].forEach(w => {
      if (!state.plans[w]) state.plans[w] = {};
      Object.keys(state.plans[w]).forEach(slotKey => {
        const val = state.plans[w][slotKey];
        if (val && !Array.isArray(val)) {
          state.plans[w][slotKey] = [val];
        }
      });
    });
    state.plan = state.plans[0]; // always start on this week
    state.favorites = saved.favorites || [];
    state.history = saved.history || [];
    state.customRecipes = saved.customRecipes || [];
    state.groceryChecked = saved.groceryChecked || {};
    state.apiKey = saved.apiKey || '';
    state.lastSyncedAt = saved.lastSyncedAt || 0;
    state.todoistKey = saved.todoistKey || '';
  } catch(e) {}

  // Populate settings fields
  document.getElementById('settings-api-key').value = state.apiKey;
  document.getElementById('settings-todoist-key').value = state.todoistKey;
}

function saveToStorage() {
  localStorage.setItem('mealplanner', JSON.stringify({
    plans: state.plans,
    favorites: state.favorites,
    history: state.history,
    customRecipes: state.customRecipes,
    groceryChecked: state.groceryChecked,
    apiKey: state.apiKey,
    lastSyncedAt: state.lastSyncedAt,
    todoistKey: state.todoistKey,
  }));
  // Trigger debounced cloud push if signed in
  schedulePush();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchView(v) {
  state.currentView = v;
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  document.getElementById('nav-' + v).classList.add('active');

  if (v === 'recipes') {
    renderFavorites();
    renderHistory();
    renderCustomRecipes();
    switchRecipeTab('mine');
  }
}

function switchRecipeTab(tab) {
  state.currentRecipeTab = tab;
  ['mine','favorites','history'].forEach(t => {
    const btn = document.getElementById('rtab-' + t);
    const content = document.getElementById('rtab-content-' + t);
    if (btn) btn.classList.toggle('active', t === tab);
    if (content) content.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'mine') { renderCustomRecipes(); initPhotoImport(); }
}

function switchWeek(offset) {
  state.weekOffset = offset;
  state.plan = state.plans[offset];
  [0, 1].forEach(i => {
    document.getElementById('week-tab-' + i).classList.toggle('active', i === offset);
  });
  document.getElementById('week-title').textContent = offset === 0 ? 'This Week' : 'Next Week';
  updateWeekTitle();
  renderWeekGrid();
  renderGroceryList();
}

function toggleSettings() {
  const bar = document.getElementById('settings-bar');
  bar.classList.toggle('open');
}

function saveSettings() {
  state.apiKey = document.getElementById('settings-api-key').value.trim();
  state.todoistKey = document.getElementById('settings-todoist-key').value.trim();

  // Save app data directly (not via saveToStorage to avoid spurious push)
  localStorage.setItem('mealplanner', JSON.stringify({
    plans: state.plans, favorites: state.favorites, history: state.history,
    customRecipes: state.customRecipes, groceryChecked: state.groceryChecked,
    apiKey: state.apiKey, lastSyncedAt: state.lastSyncedAt,
    todoistKey: state.todoistKey,
  }));

  toast('Settings saved!', 'success');
  toggleSettings();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEEK GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateWeekTitle() {
  const now = new Date();
  const sat = getMonday(now); // returns the week-start Saturday
  sat.setDate(sat.getDate() + state.weekOffset * 7);
  const fri = new Date(sat); fri.setDate(fri.getDate() + 6);
  const opts = { month: 'short', day: 'numeric' };
  document.getElementById('week-subtitle').textContent =
    `${sat.toLocaleDateString('en-US', opts)} ‚Äì ${fri.toLocaleDateString('en-US', opts)}, ${fri.getFullYear()}`;
}

function getMonday(d) {
  // Returns the most recent Saturday (start of the week)
  const dt = new Date(d);
  const day = dt.getDay(); // 0=Sun,1=Mon,...,6=Sat
  const diff = dt.getDate() - ((day + 1) % 7); // days back to Saturday
  dt.setDate(diff);
  return dt;
}

function getTodayDayIndex() {
  // JS getDay(): 0=Sun,1=Mon,2=Tue,3=Wed,4=Thu,5=Fri,6=Sat
  // DAYS order:  Sat=0,Sun=1,Mon=2,Tue=3,Wed=4,Thu=5,Fri=6
  const map = [1, 2, 3, 4, 5, 6, 0]; // map JS day ‚Üí DAYS index
  return map[new Date().getDay()];
}

function renderWeekGrid() {
  const grid = document.getElementById('week-grid');
  const todayIdx = state.weekOffset === 0 ? getTodayDayIndex() : -1; // no "today" highlight on next week
  const mon = getMonday(new Date());
  mon.setDate(mon.getDate() + state.weekOffset * 7); // offset to correct week

  let html = '';

  // Top-left corner
  html += `<div class="grid-cell grid-header"></div>`;

  // Day headers
  DAYS.forEach((day, i) => {
    const dt = new Date(mon); dt.setDate(dt.getDate() + i);
    const isToday = i === todayIdx;
    html += `<div class="grid-cell grid-header ${isToday ? 'today' : ''}">
      <div class="day-name">${day.slice(0,3)}</div>
      <div class="day-num">${dt.getDate()}</div>
    </div>`;
  });

  // Meal rows
  MEALS.forEach(meal => {
    html += `<div class="grid-cell grid-row-label"><div class="meal-pill ${meal.toLowerCase()}"><span style="font-size:0.9rem;line-height:1;">${MEAL_EMOJIS[meal]}</span><span>${meal}</span></div></div>`;
    DAYS.forEach((day, i) => {
      const key = `${day}-${meal}`;
      const slots = state.plan[key]; // now an array
      const isToday = i === todayIdx;
      const todayStyle = isToday ? ' style="border-top: 2px solid var(--accent);"' : '';
      if (slots && slots.length) {
        html += `<div class="grid-cell meal-slot ${meal}"${todayStyle} data-key="${key}" ondragover="onSlotDragOver(event)" ondragleave="onSlotDragLeave(event)" ondrop="onSlotDrop(event,'${key}')">`;
        slots.forEach((slot, idx) => {
          const servings = slot.servings || 1;
          html += `<div class="meal-card-mini" draggable="true" ondragstart="onCardDragStart(event,'${key}',${idx})" ondragend="onCardDragEnd(event)">
            <div class="meal-name meal-name-clickable" onclick="openRecipeDetail('${key}',${idx})" title="View recipe">${escHtml(slot.name)}</div>
            ${slot.source === 'ai' ? '<div class="ai-generated-badge">‚ú® AI</div>' : ''}
            <div style="font-size:0.68rem;color:var(--text-muted);margin-top:3px;">${servings} serving${servings !== 1 ? 's' : ''}</div>
            <div class="meal-actions">
              <button onclick="removeMeal('${key}',${idx})" title="Remove">‚úï</button>
            </div>
          </div>`;
        });
        html += `<button class="add-more-btn" onclick="openSlotModal('${day}','${meal}')" title="Add another recipe">+</button>`;
        html += `</div>`;
      } else {
        html += `<div class="grid-cell meal-slot ${meal} empty"${todayStyle} data-key="${key}" onclick="openSlotModal('${day}','${meal}')" ondragover="onSlotDragOver(event)" ondragleave="onSlotDragLeave(event)" ondrop="onSlotDrop(event,'${key}')">
          <button class="add-btn">+</button>
        </div>`;
      }
    });
  });

  grid.innerHTML = html;
}

function removeMeal(key, idx) {
  if (!state.plan[key]) return;
  if (typeof idx === 'number') {
    state.plan[key].splice(idx, 1);
    if (!state.plan[key].length) delete state.plan[key];
  } else {
    delete state.plan[key];
  }
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
  toast('Meal removed');
}

// ‚îÄ‚îÄ Drag and drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _dragSource = null;    // { key, idx } ‚Äî set on dragstart
let _dropPending = null;   // { srcKey, srcIdx, targetKey } ‚Äî set on drop, cleared after modal choice

function onCardDragStart(event, key, idx) {
  _dragSource = { key, idx };
  event.dataTransfer.effectAllowed = 'copyMove';
  event.dataTransfer.setData('text/plain', JSON.stringify({ key, idx }));
  setTimeout(() => event.target.classList.add('dragging'), 0);
}

function onCardDragEnd(event) {
  event.target.classList.remove('dragging');
  document.querySelectorAll('.meal-slot.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function onSlotDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'copyMove';
  const slot = event.currentTarget;
  if (!slot.classList.contains('drag-over')) slot.classList.add('drag-over');
}

function onSlotDragLeave(event) {
  if (!event.currentTarget.contains(event.relatedTarget)) {
    event.currentTarget.classList.remove('drag-over');
  }
}

function onSlotDrop(event, targetKey) {
  event.preventDefault();
  event.currentTarget.classList.remove('drag-over');

  if (!_dragSource) return;
  const { key: srcKey, idx: srcIdx } = _dragSource;
  _dragSource = null;

  // No-op if dropped onto same slot
  if (srcKey === targetKey) return;

  const srcSlots = state.plan[srcKey];
  if (!srcSlots || !srcSlots[srcIdx]) return;

  // Store pending drop and show Move/Duplicate prompt
  _dropPending = { srcKey, srcIdx, targetKey };

  const slot = srcSlots[srcIdx];
  const targetLabel = targetKey.replace('-', ' ');
  document.getElementById('drop-action-subtitle').textContent =
    `"${slot.name}" ‚Üí ${targetLabel}`;
  document.getElementById('drop-action-overlay').classList.add('open');
}

function cancelDropAction(e, force) {
  if (force || (e && e.target === document.getElementById('drop-action-overlay'))) {
    document.getElementById('drop-action-overlay').classList.remove('open');
    _dropPending = null;
  }
}

function confirmDropAction(mode) {
  if (!_dropPending) return;
  const { srcKey, srcIdx, targetKey } = _dropPending;
  _dropPending = null;
  document.getElementById('drop-action-overlay').classList.remove('open');

  const srcSlots = state.plan[srcKey];
  if (!srcSlots || !srcSlots[srcIdx]) return;

  const copy = JSON.parse(JSON.stringify(srcSlots[srcIdx]));
  if (!state.plan[targetKey]) state.plan[targetKey] = [];
  state.plan[targetKey].push(copy);

  if (mode === 'move') {
    srcSlots.splice(srcIdx, 1);
    if (!srcSlots.length) delete state.plan[srcKey];
  }

  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
  toast(mode === 'move' ? `Moved to ${targetKey.replace('-', ' ')}!` : `Duplicated to ${targetKey.replace('-', ' ')}!`, 'success');
}

function changeServings(key, idx, delta) {
  if (!state.plan[key]) return;
  const slot = Array.isArray(state.plan[key]) ? state.plan[key][idx] : state.plan[key];
  if (!slot) return;
  const current = slot.servings || 1;
  const next = Math.max(1, current + delta);
  slot.servings = next;
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
}

function clearWeek() {
  const label = state.weekOffset === 0 ? 'this week' : 'next week';
  if (!confirm(`Clear all meals from ${label}?`)) return;
  state.plans[state.weekOffset] = {};
  state.plan = state.plans[state.weekOffset];
  state.groceryChecked = {};
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
  toast('Week cleared');
}

function saveWeekToHistory() {
  const hasMeals = Object.keys(state.plan).length > 0;
  if (!hasMeals) { toast('No meals to save', 'error'); return; }

  const mon = getMonday(new Date());
  mon.setDate(mon.getDate() + state.weekOffset * 7);
  const weekLabel = mon.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  const entry = { weekOf: weekLabel, plan: JSON.parse(JSON.stringify(state.plan)), savedAt: Date.now() };

  // remove duplicate week
  state.history = state.history.filter(h => h.weekOf !== weekLabel);
  state.history.unshift(entry);
  if (state.history.length > 4) state.history = state.history.slice(0, 4);
  saveToStorage();
  toast('Week saved to history!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SLOT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let slotPickTab = 'mine';

function switchSlotPickTab(tab) {
  slotPickTab = tab;
  document.querySelectorAll('.slot-pick-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('spick-tab-' + tab).classList.add('active');
  renderSlotSavedList();
}

function renderSlotSavedList() {
  const container = document.getElementById('slot-saved-list');
  const list = slotPickTab === 'mine' ? state.customRecipes : state.favorites;

  if (!list || !list.length) {
    const label = slotPickTab === 'mine' ? 'No saved recipes yet ‚Äî create some in the Recipes tab.' : 'No favorites yet ‚Äî save recipes from search results.';
    container.innerHTML = `<div style="padding:16px;text-align:center;font-size:0.82rem;color:var(--text-muted);">${label}</div>`;
    return;
  }

  container.innerHTML = list.map((r, i) => {
    const storeKey = `_slot_saved_${slotPickTab}_${i}`;
    window[storeKey] = r;
    const ingCount = r.ingredients ? r.ingredients.length : 0;
    const meta = [r.time, ingCount ? `${ingCount} ingredients` : ''].filter(Boolean).join(' ¬∑ ');
    return `<div class="slot-saved-item">
      <div class="ssi-name" title="${escAttr(r.name)}">${escHtml(r.name)}</div>
      ${meta ? `<div class="ssi-meta">${escHtml(meta)}</div>` : ''}
      <button class="ssi-add" onclick="assignMealToSlot(window['${storeKey}'])">+ Add</button>
    </div>`;
  }).join('');
}

function showSlotPanel(panelId) {
  document.querySelectorAll('.slot-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('slot-panel-' + panelId).classList.add('active');
  const backBtn = document.getElementById('slot-back-btn');
  backBtn.style.display = panelId === 'home' ? 'none' : 'flex';
}

function openSlotModal(day, meal) {
  state.currentSlot = { day, meal };
  document.getElementById('slot-modal-title').textContent =
    `${MEAL_EMOJIS[meal]} ${day} ${meal.charAt(0).toUpperCase() + meal.slice(1)}`;

  // Reset all panels to clean state
  document.getElementById('slot-manual-input').value = '';
  document.getElementById('slot-save-recipe-checkbox').checked = false;
  document.getElementById('slot-search-input').value = '';
  document.getElementById('slot-results').innerHTML = '';
  document.getElementById('slot-recipe-name').value = '';
  document.getElementById('slot-recipe-time').value = '';
  document.getElementById('slot-recipe-servings').value = '';
  document.getElementById('slot-recipe-url').value = '';
  document.getElementById('slot-recipe-notes').value = '';
  document.getElementById('slot-url-import-input').value = '';
  document.getElementById('slot-url-import-status').innerHTML = '';
  initIngBuilder('slot-ing-rows');
  initIngBuilder('slot-recipe-ing-rows');
  initSlotPhotoImport();

  showSlotPanel('home');
  document.getElementById('slot-overlay').classList.add('open');
}

function addManualMeal() {
  const name = document.getElementById('slot-manual-input').value.trim();
  if (!name) { toast('Please enter a meal name', 'error'); return; }
  const ingredients = collectIngRows('slot-ing-rows');
  const saveAsRecipe = document.getElementById('slot-save-recipe-checkbox').checked;
  const recipe = { name, ingredients, time: '', url: '', source: 'manual', image: null };
  if (saveAsRecipe) {
    const newRecipe = { ...recipe, id: Date.now(), defaultServings: 2 };
    state.customRecipes.unshift(newRecipe);
    saveToStorage();
    toast('Recipe saved to My Recipes');
  }
  assignMealToSlot(recipe);
}

function closeSlotModal(e, force) {
  if (force || e.target === document.getElementById('slot-overlay')) {
    document.getElementById('slot-overlay').classList.remove('open');
    showSlotPanel('home');
    state.currentSlot = null;
  }
}

function saveAndAddRecipeFromSlot() {
  const name = document.getElementById('slot-recipe-name').value.trim();
  if (!name) { toast('Recipe name is required', 'error'); return; }
  const ingredients = collectIngRows('slot-recipe-ing-rows');
  const defaultServings = Math.max(1, parseInt(document.getElementById('slot-recipe-servings').value) || 1);
  const recipe = {
    id: Date.now(),
    name,
    time: document.getElementById('slot-recipe-time').value.trim(),
    url: document.getElementById('slot-recipe-url').value.trim(),
    notes: document.getElementById('slot-recipe-notes').value.trim(),
    ingredients,
    defaultServings,
    source: 'custom',
    image: null,
    createdAt: Date.now(),
  };
  state.customRecipes.unshift(recipe);
  saveToStorage();
  renderCustomRecipes();
  toast('Recipe saved to My Recipes');
  assignMealToSlot(recipe);
}

function renderSlotPopular() {
  const container = document.getElementById('slot-popular-list');
  // Count frequency of each recipe name across both weeks
  const freq = {};
  [0, 1].forEach(w => {
    const plan = state.plans[w] || {};
    Object.values(plan).forEach(slotVal => {
      const meals = Array.isArray(slotVal) ? slotVal : (slotVal ? [slotVal] : []);
      meals.forEach(m => {
        if (m && m.name) freq[m.name] = (freq[m.name] || 0) + 1;
      });
    });
  });
  // Sort by frequency, take top 5
  const top = Object.entries(freq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([name]) => name);

  if (!top.length) {
    container.innerHTML = `<div style="font-size:0.82rem;color:var(--text-muted);padding:8px 0;">No history yet ‚Äî add some meals to see popular picks here.</div>`;
    return;
  }
  // Find full recipe objects if available, else use name-only
  const pool = [...state.customRecipes, ...state.favorites];
  container.innerHTML = top.map(name => {
    const r = pool.find(p => p.name === name);
    const storeKey = `_slot_popular_${name.replace(/\W/g,'_')}`;
    window[storeKey] = r || { name, ingredients: [], source: 'manual' };
    const meta = r ? [r.time, r.ingredients?.length ? `${r.ingredients.length} ing.` : ''].filter(Boolean).join(' ¬∑ ') : '';
    return `<div class="slot-saved-item">
      <div class="ssi-name" title="${escAttr(name)}">${escHtml(name)}</div>
      ${meta ? `<div class="ssi-meta">${escHtml(meta)}</div>` : ''}
      <button class="ssi-add" onclick="assignMealToSlot(window['${storeKey}'])">+ Add</button>
    </div>`;
  }).join('');
}

function slotSearch() {
  const q = document.getElementById('slot-search-input').value.trim().toLowerCase();
  const results = document.getElementById('slot-results');
  if (!q) { results.innerHTML = ''; return; }

  // Search across custom recipes and favorites
  const pool = [
    ...state.customRecipes,
    ...state.favorites.filter(f => !state.customRecipes.some(c => c.name === f.name)),
  ];
  const matches = pool.filter(r =>
    r.name.toLowerCase().includes(q) ||
    (r.ingredients || []).some(i => i.toLowerCase().includes(q))
  );

  if (!matches.length) {
    results.innerHTML = `<div class="empty-state"><div class="emoji">üòï</div><h3>No results found</h3><p>Try different keywords, or just type the meal name above and hit + Add.</p></div>`;
    return;
  }

  results.innerHTML = matches.map((r, i) => recipeCardHTML(r, i, 'slot')).join('');
}

// Internal: actually assigns meal without showing checklist (used after checklist confirm)
function _doAssignMealToSlot(recipe, checkedIngredients) {
  if (!state.currentSlot) return;
  const key = `${state.currentSlot.day}-${state.currentSlot.meal}`;
  // Store meal with only the checked ingredients for grocery purposes
  const mealToStore = { ...recipe };
  // Default servings to defaultServings if set and not already overridden
  if (!mealToStore.servings && mealToStore.defaultServings) {
    mealToStore.servings = mealToStore.defaultServings;
  }
  if (checkedIngredients !== null) {
    mealToStore._groceryIngredients = checkedIngredients;
  }
  // Push to array (multiple recipes per slot)
  if (!state.plan[key]) state.plan[key] = [];
  state.plan[key].push(mealToStore);
  state.groceryChecked = {};
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
  closeSlotModal(null, true);
  toast(`Added "${recipe.name}" to ${state.currentSlot.day} ${state.currentSlot.meal}`, 'success');
}

function assignMealToSlot(recipe) {
  if (!state.currentSlot) return;
  // If recipe has ingredients, show checklist first
  if (recipe.ingredients && recipe.ingredients.length > 0) {
    openIngCheckModal(recipe, 'slot');
  } else {
    _doAssignMealToSlot(recipe, null);
  }
}

// ‚îÄ‚îÄ INGREDIENT CHECKLIST MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let _ingCheckPending = null; // { recipe, source: 'slot' | 'plan' }

function openIngCheckModal(recipe, source) {
  _ingCheckPending = { recipe, source };

  // Subtitle
  let subtitle = '';
  if (source === 'slot' && state.currentSlot) {
    subtitle = `${state.currentSlot.day} ¬∑ ${state.currentSlot.meal.charAt(0).toUpperCase() + state.currentSlot.meal.slice(1)}`;
  } else if (source === 'plan') {
    const dayIdx = parseInt(document.getElementById('addplan-day').value);
    const meal = document.getElementById('addplan-meal').value;
    subtitle = `${DAYS[dayIdx]} ¬∑ ${meal.charAt(0).toUpperCase() + meal.slice(1)}`;
  }
  document.getElementById('ing-check-subtitle').textContent = recipe.name + (subtitle ? ` ‚Äî ${subtitle}` : '');

  // Build checklist ‚Äî all unchecked by default
  const list = document.getElementById('ing-check-list');
  list.innerHTML = (recipe.ingredients || []).map((ing, i) => {
    const id = `ingck-${i}`;
    return `<label class="ing-check-item">
      <input type="checkbox" id="${id}" data-idx="${i}">
      <span style="font-size:0.875rem;color:var(--text);flex:1;">${escHtml(ing)}</span>
    </label>`;
  }).join('');

  // Toggle strikethrough on check
  list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      cb.closest('label').classList.toggle('checked', cb.checked);
    });
  });

  document.getElementById('ing-check-overlay').classList.add('open');
}

function closeIngCheckModal(e, force) {
  if (force || (e && e.target === document.getElementById('ing-check-overlay'))) {
    document.getElementById('ing-check-overlay').classList.remove('open');
    _ingCheckPending = null;
  }
}

function ingCheckToggleAll(checked) {
  document.querySelectorAll('#ing-check-list input[type="checkbox"]').forEach(cb => {
    cb.checked = checked;
    cb.closest('label').classList.toggle('checked', checked);
  });
}

function confirmIngCheck() {
  if (!_ingCheckPending) return;
  const { recipe, source } = _ingCheckPending;

  // Collect checked ingredients
  const checkedIngredients = [];
  document.querySelectorAll('#ing-check-list input[type="checkbox"]').forEach((cb, i) => {
    if (cb.checked && recipe.ingredients && recipe.ingredients[i]) {
      checkedIngredients.push(recipe.ingredients[i]);
    }
  });

  document.getElementById('ing-check-overlay').classList.remove('open');
  _ingCheckPending = null;

  if (source === 'slot') {
    _doAssignMealToSlot(recipe, checkedIngredients);
  } else {
    // plan source ‚Äî close the add-plan modal too
    _doConfirmAddToPlan(recipe, checkedIngredients);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECIPE DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _recipeDetailKey = null;
let _recipeDetailIdx = 0;
let _cookServings = 1; // view-only scaler ‚Äî does not affect state.plan

function openRecipeDetail(key, idx) {
  const slots = state.plan[key];
  if (!slots || !slots.length) return;
  const slotIdx = typeof idx === 'number' ? idx : 0;
  const slot = Array.isArray(slots) ? slots[slotIdx] : slots;
  if (!slot) return;
  _recipeDetailKey = key;
  _recipeDetailIdx = slotIdx;

  // Parse day/meal from key e.g. "Monday-dinner"
  const dashIdx = key.indexOf('-');
  const day = key.slice(0, dashIdx);
  const meal = key.slice(dashIdx + 1);
  const mealLabel = meal.charAt(0).toUpperCase() + meal.slice(1);

  // Slot label in header
  document.getElementById('recipe-detail-slot-label').textContent =
    `${MEAL_EMOJIS[meal]}  ${day} ¬∑ ${mealLabel}`;

  // Title
  document.getElementById('recipe-detail-title').textContent = slot.name;

  // Meta chips
  const meta = document.getElementById('recipe-detail-meta');
  let metaHtml = '';
  if (slot.time) metaHtml += `<span class="recipe-detail-chip">‚è± ${escHtml(slot.time)}</span>`;
  const servings = slot.servings || 1;
  metaHtml += `<span class="servings-chip" id="recipe-detail-servings-chip">üë§ <span id="recipe-detail-servings-count">${servings}</span> serving${servings !== 1 ? 's' : ''}<button class="servings-chip-btn" onclick="recipeDetailChangePlanServings(-1)" title="Fewer">‚àí</button><button class="servings-chip-btn" onclick="recipeDetailChangePlanServings(1)" title="More">+</button></span>`;
  if (slot.defaultServings && slot.defaultServings > 1) {
    metaHtml += `<span class="recipe-detail-chip" title="Original recipe yield">üìã Makes ${slot.defaultServings}</span>`;
  }
  if (slot.source === 'ai') metaHtml += `<span class="recipe-detail-chip">‚ú® AI generated</span>`;
  if (slot.calories) metaHtml += `<span class="recipe-detail-chip">üî• ${escHtml(slot.calories)} cal</span>`;
  meta.innerHTML = metaHtml;

  // Servings counters in footer
  document.getElementById('recipe-detail-servings-count').textContent = servings;
  _cookServings = servings; // start cook-for at same as plan servings
  document.getElementById('recipe-detail-cook-count').textContent = _cookServings;

  // URL button
  const urlBtn = document.getElementById('recipe-detail-url-btn');
  if (slot.url) {
    urlBtn.href = slot.url;
    urlBtn.style.display = '';
  } else {
    urlBtn.style.display = 'none';
  }

  // Body: ingredients + instructions (use cook servings for display)
  _renderRecipeDetailBody(slot, _cookServings);

  document.getElementById('recipe-detail-overlay').classList.add('open');
}

function _renderRecipeDetailBody(slot, servings) {
  const body = document.getElementById('recipe-detail-body');
  const ings = slot.ingredients || [];
  const notes = slot.notes || '';

  // Left column: ingredients
  // "servings" here is _cookServings (the view-only cooking amount)
  const planServings = slot.servings || 1;
  let perServingNote = '';
  if (servings !== 1 || slot.defaultServings) {
    const parts = [];
    if (slot.defaultServings && slot.defaultServings > 1) parts.push(`recipe makes ${slot.defaultServings}`);
    parts.push(`cooking for ${servings}`);
    perServingNote = `<div style="font-size:0.72rem;color:var(--accent-dark);font-weight:600;margin-bottom:8px;">üìê ${parts.join(' ¬∑ ')}</div>`;
  }
  let ingsHtml = `<div>
    <div class="recipe-detail-section-label">Ingredients</div>
    ${perServingNote}`;

  if (ings.length === 0) {
    ingsHtml += `<p style="font-size:0.85rem;color:var(--text-muted);font-style:italic;">No ingredients listed.</p>`;
  } else {
    ingsHtml += `<ul class="recipe-detail-ingredients">`;
    ings.forEach(ing => {
      const scaled = servings !== 1 ? scaleIngredient(ing.trim(), servings) : ing.trim();
      ingsHtml += `<li>${escHtml(scaled)}</li>`;
    });
    ingsHtml += `</ul>`;
  }
  ingsHtml += `</div>`;

  // Right column: instructions
  let notesHtml = `<div>
    <div class="recipe-detail-section-label">Instructions</div>`;

  if (!notes) {
    notesHtml += `<p style="font-size:0.85rem;color:var(--text-muted);font-style:italic;">No instructions saved. ${slot.url ? 'See the original recipe link below.' : 'Import a recipe via URL to get full instructions.'}</p>`;
  } else {
    // Split into steps and always render as a numbered list
    const lines = notes.trim().split(/\n+/);
    const steps = lines
      .map(l => l.trim().replace(/^(\d+[\.\)]\s*|step\s+\d+[:\.\)]\s*)/i, '').trim())
      .filter(l => l.length > 0);
    notesHtml += `<ol style="padding-left:20px;margin:0;">`;
    steps.forEach(step => {
      notesHtml += `<li style="font-size:0.875rem;line-height:1.7;margin-bottom:14px;color:var(--text);">${escHtml(step)}</li>`;
    });
    notesHtml += `</ol>`;
  }
  notesHtml += `</div>`;

  body.innerHTML = ingsHtml + notesHtml;
}

// Changes the plan's saved servings (affects grocery list + grid display)
function recipeDetailChangePlanServings(delta) {
  if (!_recipeDetailKey || !state.plan[_recipeDetailKey]) return;
  const slots = state.plan[_recipeDetailKey];
  const slot = Array.isArray(slots) ? slots[_recipeDetailIdx] : slots;
  if (!slot) return;
  const current = slot.servings || 1;
  const next = Math.max(1, current + delta);
  slot.servings = next;
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();

  // Update plan servings chip
  document.getElementById('recipe-detail-servings-count').textContent = next;
  const chip = document.getElementById('recipe-detail-servings-chip');
  if (chip) chip.innerHTML = `üë§ <span id="recipe-detail-servings-count">${next}</span> serving${next !== 1 ? 's' : ''}<button class="servings-chip-btn" onclick="recipeDetailChangePlanServings(-1)" title="Fewer">‚àí</button><button class="servings-chip-btn" onclick="recipeDetailChangePlanServings(1)" title="More">+</button>`;
  // Keep ingredients scaled to cook servings (not plan servings)
  _renderRecipeDetailBody(slot, _cookServings);
}

// Changes only the ingredient display ‚Äî does NOT affect the plan or grocery list
function recipeDetailChangeCookServings(delta) {
  if (!_recipeDetailKey || !state.plan[_recipeDetailKey]) return;
  const slots = state.plan[_recipeDetailKey];
  const slot = Array.isArray(slots) ? slots[_recipeDetailIdx] : slots;
  if (!slot) return;
  _cookServings = Math.max(1, _cookServings + delta);
  document.getElementById('recipe-detail-cook-count').textContent = _cookServings;
  _renderRecipeDetailBody(slot, _cookServings);
}

function closeRecipeDetail(e, force) {
  if (force || (e && e.target === document.getElementById('recipe-detail-overlay'))) {
    document.getElementById('recipe-detail-overlay').classList.remove('open');
    _recipeDetailKey = null;
  }
}

function openSlotModalFromDetail() {
  const key = _recipeDetailKey;
  closeRecipeDetail(null, true);
  if (!key) return;
  const dashIdx = key.indexOf('-');
  const day = key.slice(0, dashIdx);
  const meal = key.slice(dashIdx + 1);
  openSlotModal(day, meal);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INGREDIENT SCALING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Maps unicode vulgar fractions and written fractions to decimals
const FRACTION_MAP = {
  '¬Ω': 0.5, '‚Öì': 1/3, '‚Öî': 2/3, '¬º': 0.25, '¬æ': 0.75,
  '‚Öõ': 0.125, '‚Öú': 0.375, '‚Öù': 0.625, '‚Öû': 0.875,
  '1/2': 0.5, '1/3': 1/3, '2/3': 2/3, '1/4': 0.25, '3/4': 0.75,
  '1/8': 0.125, '3/8': 0.375, '5/8': 0.625, '7/8': 0.875,
  '1/6': 1/6, '5/6': 5/6, '1/5': 0.2, '2/5': 0.4, '3/5': 0.6, '4/5': 0.8,
};

// Convert a quantity string like "1 1/2" or "¬æ" to a number
function parseQuantity(str) {
  str = str.trim();
  // Replace unicode fractions
  for (const [frac, val] of Object.entries(FRACTION_MAP)) {
    str = str.replace(frac, ` ${val}`);
  }
  // Handle "X Y/Z" mixed number (after replacements)
  const parts = str.trim().split(/\s+/);
  let total = 0;
  for (const p of parts) {
    if (p.includes('/')) {
      const [n, d] = p.split('/');
      total += parseFloat(n) / parseFloat(d);
    } else {
      const n = parseFloat(p);
      if (!isNaN(n)) total += n;
    }
  }
  return total || null;
}

// Format a number back to a readable fraction/decimal
function formatQuantity(n) {
  if (n === 0) return '0';
  // Round to nearest 1/8
  const eighth = Math.round(n * 8) / 8;
  const whole = Math.floor(eighth);
  const frac = eighth - whole;
  const FRAC_LABELS = {
    0: '', 0.125: '‚Öõ', 0.25: '¬º', 0.375: '‚Öú',
    0.5: '¬Ω', 0.625: '‚Öù', 0.75: '¬æ', 0.875: '‚Öû',
  };
  const fracStr = FRAC_LABELS[Math.round(frac * 8) / 8] ?? '';
  if (whole === 0) return fracStr || String(Math.round(n * 100) / 100);
  return fracStr ? `${whole} ${fracStr}` : String(whole);
}

// Scale an ingredient string by a multiplier
// e.g. "1 cup flour" √ó 3 ‚Üí "3 cups flour"
function scaleIngredient(ingredient, multiplier) {
  if (multiplier === 1) return ingredient;
  // Regex: optional leading number+fraction, then unit, then rest
  // Matches: "2 cups", "1 1/2 tbsp", "¬æ tsp", ".375 lb", "0.5 cup", "3 large eggs", plain "salt"
  const re = /^([\d\s\u00BC-\u00BE\u2150-\u215E\/.]+)\s*(.*)/;
  const match = ingredient.match(re);
  if (!match) return ingredient; // no leading number, return as-is

  const rawQty = match[1];
  const rest = match[2];
  const qty = parseQuantity(rawQty);
  if (qty === null || qty === 0) return ingredient;

  const scaled = qty * multiplier;
  const formatted = formatQuantity(scaled);

  // Basic pluralisation of common units
  const plurals = {
    'cup': 'cups', 'tablespoon': 'tablespoons', 'tbsp': 'tbsp',
    'teaspoon': 'teaspoons', 'tsp': 'tsp', 'ounce': 'ounces', 'oz': 'oz',
    'pound': 'pounds', 'lb': 'lbs', 'gram': 'grams', 'g': 'g',
    'kg': 'kg', 'ml': 'ml', 'liter': 'liters', 'litre': 'litres',
    'clove': 'cloves', 'slice': 'slices', 'piece': 'pieces',
    'can': 'cans', 'package': 'packages', 'pkg': 'pkgs',
    'bunch': 'bunches', 'head': 'heads', 'stalk': 'stalks',
    'strip': 'strips', 'fillet': 'fillets', 'sheet': 'sheets',
  };
  // Try to pluralise first word of rest if it's a known unit
  let scaledRest = rest;
  if (scaled !== 1) {
    const firstWord = rest.split(/\s+/)[0].toLowerCase();
    for (const [sing, plur] of Object.entries(plurals)) {
      if (firstWord === sing) {
        scaledRest = rest.replace(new RegExp(`^${sing}`, 'i'), plur);
        break;
      }
    }
  }

  return `${formatted} ${scaledRest}`.trim();
}

// Divide a list of ingredient strings by servings to get per-1-serving amounts
// Returns the divided list (strings unchanged if qty can't be parsed)
function normalizeIngredientsToOneServing(ingredients, servings) {
  if (!servings || servings <= 1) return ingredients;
  return ingredients.map(ing => scaleIngredient(ing, 1 / servings));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GROCERY LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function categorizeIngredient(ingredient) {
  const lower = ingredient.toLowerCase();
  // Check if this is an herb ‚Äî apply special logic
  const isHerb = HERB_NAMES.some(h => lower.includes(h));
  if (isHerb) return categorizeHerb(ingredient);
  for (const [catKey, cat] of Object.entries(GROCERY_CATEGORIES)) {
    if (catKey === 'other') continue;
    if (cat.keywords.some(kw => lower.includes(kw))) return catKey;
  }
  return 'other';
}

// Get the base ingredient name (strip leading quantity+unit) for deduplication
function ingredientBaseName(ing) {
  const re = /^[\d\s\u00BC-\u00BE\u2150-\u215E\/.]+\s*(?:cups?|tbsp|tablespoons?|tsp|teaspoons?|oz|ounces?|lbs?|pounds?|g|kg|ml|liters?|litres?|cloves?|slices?|pieces?|cans?|packages?|pkgs?|bunches?|heads?|stalks?|strips?|fillets?|sheets?)?\s*/i;
  return ing.replace(re, '').toLowerCase().trim();
}

function renderGroceryList() {
  const container = document.getElementById('grocery-list');

  // Collect all ingredients scaled by servings
  // Map: baseName ‚Üí { displayText, totalQty, unit, cat, rawIng }
  // For same ingredient across multiple meals, we add quantities
  const ingMap = {}; // baseName ‚Üí { scaled: string, qty: number|null, unit: string, rest: string, cat }

  Object.values(state.plan).forEach(slotVal => {
    const meals = Array.isArray(slotVal) ? slotVal : [slotVal];
    meals.forEach(meal => {
      if (!meal) return;
      const servings = meal.servings || 1;
      // Use _groceryIngredients (user-selected subset) if available, else all ingredients
      const ings = meal._groceryIngredients !== undefined ? meal._groceryIngredients : (meal.ingredients || []);
      if (!ings.length) return;
      ings.forEach(ing => {
        if (!ing || !ing.trim()) return;
        const scaled = scaleIngredient(ing.trim(), servings);
        const base = ingredientBaseName(ing.trim());
        const cat = categorizeIngredient(ing);

        if (!ingMap[base]) {
          ingMap[base] = { lines: [], cat };
        }
        ingMap[base].lines.push(scaled);
      });
    });
  });

  if (!Object.keys(ingMap).length) {
    container.innerHTML = `<div class="empty-state"><div class="emoji">üõí</div><h3>No ingredients yet</h3><p>Add meals to your week to generate a grocery list.</p></div>`;
    return;
  }

  // For ingredients that appear multiple times, try to sum quantities
  const finalItems = [];
  for (const [base, data] of Object.entries(ingMap)) {
    if (data.lines.length === 1) {
      finalItems.push({ text: data.lines[0], cat: data.cat });
    } else {
      // Try to merge: parse each, sum quantities if same unit, otherwise list all
      const merged = tryMergeIngredients(data.lines);
      finalItems.push({ text: merged, cat: data.cat });
    }
  }

  // Categorize
  const cats = {};
  finalItems.forEach(item => {
    if (!cats[item.cat]) cats[item.cat] = [];
    cats[item.cat].push(item.text);
  });

  const orderedCats = ['produce','meat','dairy','grains','canned','frozen','other'];

  let html = '<div class="grocery-grid">';
  orderedCats.forEach(catKey => {
    if (!cats[catKey] || !cats[catKey].length) return;
    const cat = GROCERY_CATEGORIES[catKey];
    html += `<div class="grocery-category">
      <h4>${cat.emoji} ${cat.label}</h4>`;
    cats[catKey].forEach((ing, i) => {
      const id = `grocery-${catKey}-${i}`;
      const checked = state.groceryChecked[id] ? 'checked' : '';
      html += `<div class="grocery-item">
        <input type="checkbox" id="${id}" ${checked} onchange="toggleGroceryItem('${id}', this.checked)">
        <label for="${id}">${escHtml(ing)}</label>
      </div>`;
    });
    html += `</div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

// Try to sum scaled ingredient strings that refer to the same ingredient
// e.g. ["2 cups flour", "1 cup flour"] ‚Üí "3 cups flour"
function tryMergeIngredients(lines) {
  if (lines.length === 0) return '';
  if (lines.length === 1) return lines[0];

  // Extract leading qty + unit from each line
  const unitRe = /^([\d\s¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû\/\.]+)\s*(cups?|tbsp|tablespoons?|tsp|teaspoons?|oz|ounces?|lbs?|pounds?|g\b|kg|ml|liters?|litres?|cloves?|slices?|pieces?|cans?|packages?|pkgs?|bunches?|heads?|stalks?|strips?|fillets?|sheets?)?\s*(.*)/i;

  let totalQty = 0;
  let unit = '';
  let rest = '';
  let canMerge = true;

  for (const line of lines) {
    const m = line.match(unitRe);
    if (!m) { canMerge = false; break; }
    const qty = parseQuantity(m[1]);
    if (qty === null) { canMerge = false; break; }
    const lineUnit = (m[2] || '').toLowerCase().replace(/s$/, ''); // singularise
    const lineRest = m[3].trim();

    if (unit === '' && lineUnit) unit = lineUnit;
    if (rest === '') rest = lineRest;

    // Units must match (or both be empty) to merge
    const normUnit = lineUnit.replace(/s$/, '');
    if (normUnit !== unit.replace(/s$/, '') && lineUnit !== '') { canMerge = false; break; }
    totalQty += qty;
  }

  if (!canMerge) {
    // Can't cleanly sum ‚Äî join with " + "
    return lines.join(' + ');
  }

  const formatted = formatQuantity(totalQty);
  // Re-pluralise unit
  const plurals2 = { 'cup':'cups','tablespoon':'tablespoons','teaspoon':'teaspoons',
    'ounce':'ounces','pound':'pounds','clove':'cloves','slice':'slices',
    'piece':'pieces','can':'cans','package':'packages','bunch':'bunches',
    'head':'heads','stalk':'stalks','strip':'strips','fillet':'fillets','sheet':'sheets' };
  const displayUnit = totalQty !== 1 && plurals2[unit] ? plurals2[unit] : unit;
  return [formatted, displayUnit, rest].filter(Boolean).join(' ');
}

function toggleGroceryItem(id, checked) {
  state.groceryChecked[id] = checked;
  saveToStorage();
}

function uncheckAll() {
  state.groceryChecked = {};
  saveToStorage();
  renderGroceryList();
}

function copyGroceryList() {
  const items = [];
  const ingMap = {};

  Object.values(state.plan).forEach(slotVal => {
    const meals = Array.isArray(slotVal) ? slotVal : [slotVal];
    meals.forEach(meal => {
      if (!meal) return;
      const servings = meal.servings || 1;
      const ings = meal._groceryIngredients !== undefined ? meal._groceryIngredients : (meal.ingredients || []);
      if (!ings.length) return;
      ings.forEach(ing => {
        if (!ing || !ing.trim()) return;
        const scaled = scaleIngredient(ing.trim(), servings);
        const base = ingredientBaseName(ing.trim());
        const cat = categorizeIngredient(ing);
        if (!ingMap[base]) ingMap[base] = { lines: [], cat };
        ingMap[base].lines.push(scaled);
      });
    });
  });

  const cats = {};
  for (const [, data] of Object.entries(ingMap)) {
    const text = data.lines.length === 1 ? data.lines[0] : tryMergeIngredients(data.lines);
    if (!cats[data.cat]) cats[data.cat] = [];
    cats[data.cat].push(text);
  }

  const orderedCats = ['produce','meat','dairy','grains','canned','frozen','other'];
  orderedCats.forEach(catKey => {
    if (!cats[catKey] || !cats[catKey].length) return;
    items.push(`\n${GROCERY_CATEGORIES[catKey].emoji} ${GROCERY_CATEGORIES[catKey].label.toUpperCase()}`);
    cats[catKey].forEach(ing => items.push(`  ‚Ä¢ ${ing}`));
  });

  if (!items.length) { toast('Nothing to copy', 'error'); return; }

  navigator.clipboard.writeText('GROCERY LIST\n' + items.join('\n'))
    .then(() => toast('Copied to clipboard!', 'success'))
    .catch(() => toast('Copy failed', 'error'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TODOIST EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Maps app grocery categories to Todoist section name keywords
const TODOIST_SECTION_MAP = {
  produce: ['produce', 'fruit', 'veg'],
  meat:    ['meat', 'seafood', 'fish', 'poultry'],
  dairy:   ['refrigerat', 'dairy', 'deli', 'cold'],
  grains:  ['pantry', 'grain', 'bread', 'baking', 'dry'],
  canned:  ['pantry', 'canned', 'can', 'jar'],
  frozen:  ['frozen'],
  other:   [], // no section for uncategorized items
};

// Herb keywords ‚Äî fresh herbs ‚Üí produce, dried herbs ‚Üí pantry
const FRESH_HERB_KEYWORDS = ['fresh','bunch','leaves','sprig','sprigs','stalk','stalks'];
const DRIED_HERB_KEYWORDS = ['dried','ground','powder','powdered','flakes'];
const HERB_NAMES = ['basil','cilantro','parsley','mint','dill','rosemary','thyme','oregano',
  'sage','tarragon','chive','chives','bay leaf','bay leaves','lemongrass','marjoram',
  'fennel frond','fennel fronds'];

function categorizeHerb(ingredientStr) {
  const lower = ingredientStr.toLowerCase();
  // Dried indicators ‚Üí pantry
  if (DRIED_HERB_KEYWORDS.some(kw => lower.includes(kw))) return 'grains';
  // Fresh indicators ‚Üí produce
  if (FRESH_HERB_KEYWORDS.some(kw => lower.includes(kw))) return 'produce';
  // Default small-quantity herbs (tsp/tbsp) ‚Üí pantry, otherwise produce
  const smallUnit = /^\s*[\d\/\s¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû\.]+\s*(tsp|tbsp|teaspoon|tablespoon)/i;
  if (smallUnit.test(ingredientStr)) return 'grains';
  return 'produce';
}

function matchSectionId(cat, sections) {
  const keywords = TODOIST_SECTION_MAP[cat];
  if (!keywords || keywords.length === 0) return null; // no section for 'other' or unknown
  for (const kw of keywords) {
    const sec = sections.find(s => {
      // Strip emojis and extra whitespace for matching
      const name = s.name.replace(/[\u{1F000}-\u{1FFFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '').toLowerCase().trim();
      return name.includes(kw);
    });
    if (sec) return sec.id;
  }
  return null;
}

async function todoistFetch(token, path, options = {}) {
  const proxy = 'https://corsproxy.io/?url=';
  const res = await fetch(proxy + encodeURIComponent('https://api.todoist.com' + path), {
    ...options,
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      ...(options.headers || {}),
    },
  });
  return res;
}

async function findGroceriesProject(token) {
  const res = await todoistFetch(token, '/api/v1/projects');
  if (!res.ok) throw new Error(`Todoist auth failed (HTTP ${res.status}) ‚Äî check your API token`);
  const data = await res.json();
  const projects = Array.isArray(data) ? data : (data.results || data.items || []);
  const match = projects.find(p => p.name && p.name.toLowerCase().includes('grocer'));
  return match ? match.id : null;
}

async function fetchSections(token, projectId) {
  const res = await todoistFetch(token, `/api/v1/sections?project_id=${projectId}`);
  if (!res.ok) return [];
  const data = await res.json();
  return Array.isArray(data) ? data : (data.results || data.items || []);
}

async function fetchExistingTaskNames(token, projectId) {
  const path = projectId ? `/api/v1/tasks?project_id=${projectId}` : '/api/v1/tasks';
  const res = await todoistFetch(token, path);
  if (!res.ok) return new Set();
  const data = await res.json();
  const tasks = Array.isArray(data) ? data : (data.results || data.items || []);
  // Normalise to lowercase base names for fuzzy matching
  return new Set(tasks.map(t => ingredientBaseName(t.content).toLowerCase()));
}

async function exportToTodoist() {
  if (!state.todoistKey) {
    toast('Add your Todoist API token in ‚öôÔ∏è Settings first', 'error');
    toggleSettings();
    return;
  }

  // Collect grocery items grouped by category
  const ingMap = {};
  Object.values(state.plan).forEach(slotVal => {
    const meals = Array.isArray(slotVal) ? slotVal : [slotVal];
    meals.forEach(meal => {
      if (!meal) return;
      const servings = meal.servings || 1;
      // Use _groceryIngredients (user-selected subset) if available, else all ingredients
      const ings = meal._groceryIngredients !== undefined ? meal._groceryIngredients : (meal.ingredients || []);
      if (!ings.length) return;
      ings.forEach(ing => {
        if (!ing || !ing.trim()) return;
        const scaled = scaleIngredient(ing.trim(), servings);
        const base = ingredientBaseName(ing.trim());
        const cat = categorizeIngredient(ing);
        if (!ingMap[base]) ingMap[base] = { lines: [], cat };
        ingMap[base].lines.push(scaled);
      });
    });
  });

  // Build list of { text, cat } items
  const catItems = {}; // cat -> [text]
  for (const [, data] of Object.entries(ingMap)) {
    const text = data.lines.length === 1 ? data.lines[0] : tryMergeIngredients(data.lines);
    if (!catItems[data.cat]) catItems[data.cat] = [];
    catItems[data.cat].push(text);
  }

  const totalItems = Object.values(catItems).reduce((n, arr) => n + arr.length, 0);
  if (!totalItems) { toast('Nothing to export ‚Äî add meals with ingredients first', 'error'); return; }

  toast('Finding your Groceries project‚Ä¶', 'success');

  let projectId = null;
  try {
    projectId = await findGroceriesProject(state.todoistKey);
  } catch(e) {
    toast(e.message, 'error');
    return;
  }

  // Fetch sections and existing tasks in parallel
  const [sections, existingNames] = await Promise.all([
    projectId ? fetchSections(state.todoistKey, projectId) : Promise.resolve([]),
    fetchExistingTaskNames(state.todoistKey, projectId),
  ]);

  let added = 0;
  let skipped = 0;
  let failed = 0;
  const orderedCats = ['produce','meat','dairy','grains','canned','frozen','other'];

  for (const cat of orderedCats) {
    const items = catItems[cat];
    if (!items || !items.length) continue;
    const sectionId = sections.length ? matchSectionId(cat, sections) : null;

    for (const item of items) {
      // Skip if an item with the same base name already exists in the project
      if (existingNames.has(ingredientBaseName(item).toLowerCase())) {
        skipped++;
        continue;
      }
      try {
        const body = { content: item };
        if (projectId) body.project_id = projectId;
        if (sectionId) body.section_id = sectionId;
        const res = await todoistFetch(state.todoistKey, '/api/v1/tasks', {
          method: 'POST',
          body: JSON.stringify(body),
        });
        if (res.ok) { added++; } else { failed++; }
      } catch(e) { failed++; }
    }
  }

  const dest = projectId ? 'Groceries' : 'Inbox';
  const withSections = sections.length ? ' with sections' : '';
  if (failed === 0) {
    if (added === 0 && skipped > 0) {
      toast(`All ${skipped} items already in ${dest} ‚Äî nothing new to add.`, 'success');
    } else if (skipped > 0) {
      toast(`‚úÖ ${added} added to ${dest}${withSections}, ${skipped} already there (skipped).`, 'success');
    } else {
      toast(`‚úÖ ${added} items added to ${dest}${withSections}!`, 'success');
    }
  } else {
    toast(`Added ${added}, skipped ${skipped}, failed ${failed}. Check your token.`, 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECIPE CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RECIPE CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function recipeCardHTML(r, i, context) {
  const imgHtml = r.image
    ? `<div class="recipe-img"><img src="${escAttr(r.image)}" alt="${escAttr(r.name)}" loading="lazy" onerror="this.parentElement.innerHTML='üçΩ'"></div>`
    : `<div class="recipe-img">üçΩ</div>`;

  const isFav = isFavorite(r.name);
  const storeKey = `_tmp_recipe_${context}_${i}`;
  window[storeKey] = r;

  let footerBtns = '';

  if (context === 'slot') {
    footerBtns = `<button class="btn btn-primary btn-sm" onclick="assignMealToSlot(window['${storeKey}'])">+ Add to slot</button>`;
  } else {
    footerBtns = `<button class="btn btn-secondary btn-sm" onclick="openAddPlanModal(window['${storeKey}'])">üìÖ Add to plan</button>`;
  }

  footerBtns += ` <button class="btn btn-secondary btn-sm ${isFav ? 'btn-ghost' : ''}" onclick="toggleFavorite(window['${storeKey}'], this)">
    ${isFav ? '‚≠ê Saved' : '‚òÜ Save'}
  </button>`;

  if (r.url) {
    footerBtns += `<a href="${escAttr(r.url)}" target="_blank" rel="noopener" class="btn btn-ghost btn-sm">üîó View</a>`;
  }

  return `<div class="recipe-card">
    ${imgHtml}
    <div class="recipe-body">
      <div class="recipe-title">${escHtml(r.name)}</div>
      <div class="recipe-meta">
        ${r.time ? `<span>‚è± ${escHtml(r.time)}</span>` : ''}
        ${r.calories ? `<span>üî• ${escHtml(r.calories)}</span>` : ''}
        ${r.source === 'ai' ? '<span class="ai-generated-badge">‚ú® AI</span>' : ''}
        ${r.source === 'edamam' ? '<span class="badge badge-blue">Edamam</span>' : ''}
        ${r.source === 'builtin' ? '<span class="badge badge-green">Built-in</span>' : ''}
      </div>
      <div class="recipe-ingredients">
        <strong>Ingredients:</strong><br>
        ${(r.ingredients || []).slice(0, 6).map(escHtml).join(', ')}
        ${(r.ingredients || []).length > 6 ? ` <em>+${r.ingredients.length - 6} more</em>` : ''}
      </div>
      <div class="recipe-footer">${footerBtns}</div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD TO PLAN MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openAddPlanModal(recipe) {
  state.pendingAddRecipe = recipe;
  document.getElementById('addplan-recipe-name').textContent = recipe.name;

  // Pre-select today
  const todayIdx = getTodayDayIndex();
  document.getElementById('addplan-day').value = todayIdx;
  document.getElementById('addplan-meal').value = 'dinner';

  document.getElementById('addplan-overlay').classList.add('open');
}

function closeAddPlanModal(e, force) {
  if (force || e.target === document.getElementById('addplan-overlay')) {
    document.getElementById('addplan-overlay').classList.remove('open');
  }
}

function confirmAddToPlan() {
  if (!state.pendingAddRecipe) return;
  const recipe = state.pendingAddRecipe;
  // If recipe has ingredients, show checklist first (keep addplan modal open behind)
  if (recipe.ingredients && recipe.ingredients.length > 0) {
    openIngCheckModal(recipe, 'plan');
  } else {
    _doConfirmAddToPlan(recipe, null);
  }
}

function _doConfirmAddToPlan(recipe, checkedIngredients) {
  const dayIdx = parseInt(document.getElementById('addplan-day').value);
  const meal = document.getElementById('addplan-meal').value;
  const day = DAYS[dayIdx];
  const key = `${day}-${meal}`;
  const mealToStore = { ...recipe };
  // Default servings to defaultServings if set
  if (!mealToStore.servings && mealToStore.defaultServings) {
    mealToStore.servings = mealToStore.defaultServings;
  }
  if (checkedIngredients !== null) {
    mealToStore._groceryIngredients = checkedIngredients;
  }
  // Push to array (multiple recipes per slot)
  if (!state.plan[key]) state.plan[key] = [];
  state.plan[key].push(mealToStore);
  state.groceryChecked = {};
  saveToStorage();
  renderWeekGrid();
  renderGroceryList();
  closeAddPlanModal(null, true);
  state.pendingAddRecipe = null;
  toast(`Added to ${day} ${meal}!`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FAVORITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function isFavorite(name) {
  return state.favorites.some(f => f.name === name);
}

function toggleFavorite(recipe, btn) {
  if (isFavorite(recipe.name)) {
    state.favorites = state.favorites.filter(f => f.name !== recipe.name);
    if (btn) btn.innerHTML = '‚òÜ Save';
    toast('Removed from favorites');
  } else {
    state.favorites.unshift({ ...recipe, savedAt: Date.now() });
    if (btn) btn.innerHTML = '‚≠ê Saved';
    toast('Saved to favorites!', 'success');
  }
  saveToStorage();
  renderFavorites();
}

function saveFavoriteFromSlot(key, idx) {
  const slots = state.plan[key];
  if (!slots) return;
  const recipe = Array.isArray(slots) ? slots[typeof idx === 'number' ? idx : 0] : slots;
  if (!recipe) return;
  if (!isFavorite(recipe.name)) {
    state.favorites.unshift({ ...recipe, savedAt: Date.now() });
    saveToStorage();
    renderFavorites();
    renderWeekGrid();
    toast('Saved to favorites!', 'success');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INGREDIENT BUILDER UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const UNITS = [
  { value: '',      label: '‚Äî none ‚Äî' },
  // Volume
  { value: 'tsp',   label: 'tsp' },
  { value: 'tbsp',  label: 'tbsp' },
  { value: 'fl oz', label: 'fl oz' },
  { value: 'cup',   label: 'cup' },
  { value: 'ml',    label: 'ml' },
  { value: 'l',     label: 'liter' },
  // Weight
  { value: 'oz',    label: 'oz' },
  { value: 'lb',    label: 'lb' },
  { value: 'g',     label: 'g' },
  { value: 'kg',    label: 'kg' },
  // Count / other
  { value: 'whole', label: 'whole' },
  { value: 'clove', label: 'clove' },
  { value: 'slice', label: 'slice' },
  { value: 'can',   label: 'can' },
  { value: 'pkg',   label: 'package' },
  { value: 'bunch', label: 'bunch' },
  { value: 'pinch', label: 'pinch' },
  { value: 'dash',  label: 'dash' },
  { value: 'piece', label: 'piece' },
  { value: 'sprig', label: 'sprig' },
  { value: 'strip', label: 'strip' },
];

const UNIT_SELECT_HTML = UNITS.map(u =>
  `<option value="${u.value}">${u.label}</option>`
).join('');

// Create one blank ingredient row and append to containerId
function addIngRow(containerId, qty = '', unit = '', name = '') {
  const container = document.getElementById(containerId);
  const row = document.createElement('div');
  row.className = 'ing-row';
  row.innerHTML = `
    <input type="text" class="ing-qty" placeholder="1¬Ω" value="${escAttr(qty)}"
      style="text-align:right;" />
    <select class="ing-unit">${UNIT_SELECT_HTML}</select>
    <input type="text" class="ing-name" placeholder="e.g. flour" value="${escAttr(name)}" />
    <button class="ing-del" onclick="this.closest('.ing-row').remove()" title="Remove">‚úï</button>
  `;
  // Set unit value after inserting (can't do it via innerHTML easily)
  row.querySelector('.ing-unit').value = unit;
  // Tab from qty ‚Üí unit ‚Üí name
  row.querySelector('.ing-qty').addEventListener('keydown', e => {
    if (e.key === 'Tab' && !e.shiftKey) { e.preventDefault(); row.querySelector('.ing-unit').focus(); }
  });
  row.querySelector('.ing-unit').addEventListener('keydown', e => {
    if (e.key === 'Tab' && !e.shiftKey) { e.preventDefault(); row.querySelector('.ing-name').focus(); }
  });
  // Enter on name adds next row
  row.querySelector('.ing-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); addIngRow(containerId); }
    if (e.key === 'Tab' && !e.shiftKey) { e.preventDefault(); addIngRow(containerId); }
  });
  container.appendChild(row);
  // Auto-focus the qty field of the new row
  row.querySelector('.ing-qty').focus();
}

// Clear the container and add one blank row
function initIngBuilder(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  addIngRow(containerId);
}

// Parse an existing ingredient string like "1¬Ω cups flour" into { qty, unit, name }
function parseIngredientString(str) {
  str = str.trim();
  // Match leading qty (digits, spaces, fractions, unicode fractions)
  const qtyRe = /^([\d\s¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû\/\.]+)/;
  const qtyMatch = str.match(qtyRe);
  let qty = '';
  let rest = str;
  if (qtyMatch) {
    qty = qtyMatch[1].trim();
    rest = str.slice(qtyMatch[0].length).trim();
  }
  // Strip leading "of" (e.g. "1 cup of flour" ‚Üí "flour" after unit match)
  // Also strip parenthetical descriptors like "(packed)" before unit matching
  rest = rest.replace(/^\s*of\s+/i, '');
  // Match unit ‚Äî try full unit name and common plurals/abbreviations
  const unitValues = UNITS.map(u => u.value).filter(Boolean);
  unitValues.sort((a, b) => b.length - a.length);
  let unit = '';
  for (const u of unitValues) {
    const escaped = u.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Match unit followed by whitespace or end, optionally with trailing 's'
    const re = new RegExp(`^(${escaped}s?)(?:\\s|$)`, 'i');
    if (re.test(rest)) {
      unit = u;
      rest = rest.replace(re, '').trim();
      // Strip leading "of" again after unit (e.g. "cups of")
      rest = rest.replace(/^of\s+/i, '');
      break;
    }
  }
  // Strip leading descriptors that aren't ingredients (large, small, medium, fresh, etc.)
  // but only if they appear before a comma or the rest looks like a real ingredient name
  return { qty, unit, name: rest };
}

// Populate a builder from an array of ingredient strings
function populateIngBuilder(containerId, ingredients) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if (!ingredients || !ingredients.length) {
    addIngRow(containerId);
    return;
  }
  ingredients.forEach(ing => {
    if (!ing || !ing.trim()) return;
    const { qty, unit, name } = parseIngredientString(ing);
    addIngRow(containerId, qty, unit, name);
  });
  // Always leave one blank row at the end
  addIngRow(containerId);
}

// Read all rows and return array of ingredient strings like "1¬Ω cups flour"
function collectIngRows(containerId) {
  const container = document.getElementById(containerId);
  const rows = container.querySelectorAll('.ing-row');
  const result = [];
  rows.forEach(row => {
    const qty  = row.querySelector('.ing-qty').value.trim();
    const unit = row.querySelector('.ing-unit').value.trim();
    const name = row.querySelector('.ing-name').value.trim();
    if (!name) return; // skip empty name rows
    const parts = [qty, unit, name].filter(Boolean);
    result.push(parts.join(' '));
  });
  return result;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUSTOM RECIPES & URL IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _editingRecipeId = null; // null = create mode, number = edit mode

function saveCustomRecipe() {
  const name = document.getElementById('new-recipe-name').value.trim();
  if (!name) { toast('Recipe name is required', 'error'); return; }
  const ingredients = collectIngRows('new-recipe-ing-rows');
  const servingsRaw = parseInt(document.getElementById('new-recipe-servings').value) || 1;
  const defaultServings = Math.max(1, servingsRaw);

  if (_editingRecipeId !== null) {
    // Update existing recipe
    const idx = state.customRecipes.findIndex(r => r.id === _editingRecipeId);
    if (idx !== -1) {
      state.customRecipes[idx] = {
        ...state.customRecipes[idx],
        name,
        time: document.getElementById('new-recipe-time').value.trim(),
        url: document.getElementById('new-recipe-url').value.trim(),
        notes: document.getElementById('new-recipe-notes').value.trim(),
        ingredients,
        defaultServings,
        updatedAt: Date.now(),
      };
      // Also update any plan slots that reference this recipe by id (multi-recipe aware)
      Object.keys(state.plans).forEach(weekKey => {
        Object.keys(state.plans[weekKey]).forEach(slotKey => {
          const slotVal = state.plans[weekKey][slotKey];
          const arr = Array.isArray(slotVal) ? slotVal : (slotVal ? [slotVal] : []);
          arr.forEach((slot, i) => {
            if (slot && slot.id === _editingRecipeId) {
              arr[i] = { ...slot, ...state.customRecipes[idx] };
            }
          });
          if (Array.isArray(slotVal)) state.plans[weekKey][slotKey] = arr;
        });
      });
      state.plan = state.plans[state.weekOffset];
    }
    _editingRecipeId = null;
    toast('Recipe updated!', 'success');
  } else {
    // Create new recipe
    const recipe = {
      id: Date.now(),
      name,
      time: document.getElementById('new-recipe-time').value.trim(),
      url: document.getElementById('new-recipe-url').value.trim(),
      notes: document.getElementById('new-recipe-notes').value.trim(),
      ingredients,
      defaultServings,
      source: 'custom',
      image: null,
      createdAt: Date.now(),
    };
    state.customRecipes.unshift(recipe);
    toast('Recipe saved!', 'success');
  }

  saveToStorage();
  renderCustomRecipes();
  renderWeekGrid();
  _resetRecipeForm();
}

function _resetRecipeForm() {
  ['new-recipe-name','new-recipe-time','new-recipe-url','new-recipe-notes']
    .forEach(id => document.getElementById(id).value = '');
  document.getElementById('new-recipe-servings').value = '';
  initIngBuilder('new-recipe-ing-rows');
  document.getElementById('recipe-form-title').textContent = '‚úèÔ∏è Create a Recipe';
  document.getElementById('recipe-save-btn').textContent = 'üíæ Save Recipe';
  document.getElementById('recipe-cancel-edit-btn').style.display = 'none';
  _editingRecipeId = null;
}

function editCustomRecipe(id) {
  const recipe = state.customRecipes.find(r => r.id === id);
  if (!recipe) return;
  _editingRecipeId = id;

  document.getElementById('new-recipe-name').value = recipe.name || '';
  document.getElementById('new-recipe-time').value = recipe.time || '';
  document.getElementById('new-recipe-url').value = recipe.url || '';
  document.getElementById('new-recipe-notes').value = recipe.notes || '';
  document.getElementById('new-recipe-servings').value = recipe.defaultServings || 1;
  initIngBuilder('new-recipe-ing-rows');
  populateIngBuilder('new-recipe-ing-rows', recipe.ingredients || []);

  document.getElementById('recipe-form-title').textContent = '‚úèÔ∏è Edit Recipe';
  document.getElementById('recipe-save-btn').textContent = 'üíæ Update Recipe';
  document.getElementById('recipe-cancel-edit-btn').style.display = '';

  // Scroll to form
  document.getElementById('recipe-form-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function cancelEditRecipe() {
  _resetRecipeForm();
}

function deleteCustomRecipe(id) {
  if (!confirm('Delete this recipe?')) return;
  state.customRecipes = state.customRecipes.filter(r => r.id !== id);
  saveToStorage();
  renderCustomRecipes();
  toast('Recipe deleted');
}

function renderCustomRecipes() {
  const container = document.getElementById('custom-recipes-grid');
  if (!state.customRecipes.length) {
    container.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="emoji">üìù</div><h3>No custom recipes yet</h3><p>Create one above or import from a URL.</p></div>`;
    return;
  }
  container.innerHTML = state.customRecipes.map((r, i) => {
    const storeKey = `_tmp_recipe_custom_${i}`;
    window[storeKey] = r;
    const isFav = isFavorite(r.name);
    const imgHtml = `<div class="recipe-img">üìù</div>`;
    let footerBtns = `<button class="btn btn-secondary btn-sm" onclick="openAddPlanModal(window['${storeKey}'])">üìÖ Add to plan</button>`;
    footerBtns += ` <button class="btn btn-secondary btn-sm" onclick="toggleFavorite(window['${storeKey}'], this)">${isFav ? '‚≠ê Saved' : '‚òÜ Save'}</button>`;
    footerBtns += ` <button class="btn btn-ghost btn-sm" onclick="editCustomRecipe(${r.id})">‚úèÔ∏è Edit</button>`;
    if (r.url) footerBtns += ` <a href="${escAttr(r.url)}" target="_blank" rel="noopener" class="btn btn-ghost btn-sm">üîó View</a>`;
    footerBtns += ` <button class="btn btn-danger btn-sm" onclick="deleteCustomRecipe(${r.id})">üóë</button>`;
    const servingsLabel = r.defaultServings && r.defaultServings > 1 ? `<span>üë§ Makes ${r.defaultServings}</span>` : '';
    return `<div class="recipe-card">
      ${imgHtml}
      <div class="recipe-body">
        <div class="recipe-title">${escHtml(r.name)}</div>
        <div class="recipe-meta">
          ${r.time ? `<span>‚è± ${escHtml(r.time)}</span>` : ''}
          ${servingsLabel}
          <span class="badge badge-green">Custom</span>
        </div>
        <div class="recipe-ingredients">
          <strong>Ingredients:</strong><br>
          ${r.ingredients.slice(0,6).map(escHtml).join(', ')}
          ${r.ingredients.length > 6 ? ` <em>+${r.ingredients.length - 6} more</em>` : ''}
        </div>
        ${r.notes ? `<div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:8px;font-style:italic;">${escHtml(r.notes.slice(0,120))}${r.notes.length>120?'‚Ä¶':''}</div>` : ''}
        <div class="recipe-footer">${footerBtns}</div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PHOTO RECIPE IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _photoFiles = [];

function initPhotoImport() {
  _photoFiles = [];
  const input = document.getElementById('photo-file-input');
  if (input) input.value = '';
  renderPhotoThumbnails();
  const status = document.getElementById('photo-import-status');
  if (status) status.innerHTML = '';
}

function addPhotoFiles(fileList) {
  const status = document.getElementById('photo-import-status');
  for (const file of fileList) {
    if (!file.type.startsWith('image/')) {
      if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Only image files are supported.</span>`;
      continue;
    }
    if (_photoFiles.length >= 3) {
      if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Maximum 3 photos allowed.</span>`;
      break;
    }
    _photoFiles.push(file);
  }
  // Reset input so same file can be re-selected if needed
  const input = document.getElementById('photo-file-input');
  if (input) input.value = '';
  renderPhotoThumbnails();
}

function removePhoto(index) {
  _photoFiles.splice(index, 1);
  renderPhotoThumbnails();
}

function renderPhotoThumbnails() {
  const container = document.getElementById('photo-thumbnails');
  const parseBtn  = document.getElementById('photo-parse-btn');
  const addBtn    = document.getElementById('photo-add-btn');
  const clearBtn  = document.getElementById('photo-clear-btn');
  const dropzone  = document.getElementById('photo-dropzone');
  if (!container) return;

  const hasPhotos = _photoFiles.length > 0;

  // Show/hide buttons
  if (parseBtn) parseBtn.style.display = hasPhotos ? '' : 'none';
  if (addBtn)   addBtn.style.display   = (hasPhotos && _photoFiles.length < 3) ? '' : 'none';
  if (clearBtn) clearBtn.style.display = hasPhotos ? '' : 'none';
  if (dropzone) dropzone.style.display = hasPhotos ? 'none' : '';

  if (!hasPhotos) { container.innerHTML = ''; return; }

  container.innerHTML = _photoFiles.map((file, i) => {
    const url = URL.createObjectURL(file);
    return `<div class="photo-thumb">
      <img src="${url}" alt="Recipe photo ${i+1}" onload="URL.revokeObjectURL(this.src)" />
      <button class="photo-thumb-remove" onclick="removePhoto(${i})" title="Remove">‚úï</button>
    </div>`;
  }).join('');
}

function resizeImageToBase64(file) {
  return new Promise((resolve, reject) => {
    const MAX = 1600;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else       { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        const base64 = dataUrl.split(',')[1];
        resolve({ base64, mediaType: 'image/jpeg' });
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function parsePhotosWithClaude() {
  const status = document.getElementById('photo-import-status');
  if (!_photoFiles.length) {
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Please add at least one photo first.</span>`;
    return;
  }
  if (!state.apiKey) {
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è An Anthropic API key is required. Add one in ‚öôÔ∏è Settings.</span>`;
    return;
  }

  const parseBtn = document.getElementById('photo-parse-btn');
  if (parseBtn) { parseBtn.disabled = true; parseBtn.textContent = 'Parsing‚Ä¶'; }
  if (status) status.innerHTML = `<span><div class="spinner dark" style="display:inline-block;vertical-align:middle;margin-right:6px;"></div> Reading recipe from photo${_photoFiles.length > 1 ? 's' : ''}‚Ä¶</span>`;

  try {
    // Resize all photos and convert to base64
    const imageData = await Promise.all(_photoFiles.map(resizeImageToBase64));

    // Build content array: image blocks + text prompt
    const content = [
      ...imageData.map(({ base64, mediaType }) => ({
        type: 'image',
        source: { type: 'base64', media_type: mediaType, data: base64 },
      })),
      {
        type: 'text',
        text: `Look at this recipe from a cookbook. Extract all recipe details and return ONLY a JSON object (no markdown, no explanation):
{
  "name": "Recipe name",
  "time": "total prep + cook time",
  "servings": 4,
  "ingredients": ["1 cup flour", "2 eggs", ...],
  "notes": "Complete step-by-step cooking instructions as written. Include all steps, temperatures, times, and techniques. Do not summarize."
}
If multiple pages are shown, combine them into one recipe. List every ingredient you can see exactly as written for the full recipe yield. "servings" should be the integer number of servings the recipe makes (e.g. 4 if it says "serves 4", 1 if unknown).`,
      },
    ];

    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        messages: [{ role: 'user', content }],
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || `API error ${res.status}`);
    }

    const aiData = await res.json();
    const aiText = aiData.content[0].text.trim();
    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Could not parse recipe from the photo. Try a clearer image.');
    const parsed = JSON.parse(jsonMatch[0]);
    if (!parsed.name) throw new Error('No recipe name found. Try a clearer image.');

    // Normalize ingredients to per-1-serving
    const defaultServings = Math.max(1, parseInt(parsed.servings) || 1);
    const normalizedIngredients = normalizeIngredientsToOneServing(parsed.ingredients || [], defaultServings);

    // Pre-fill the recipe form (same as importFromUrl)
    document.getElementById('new-recipe-name').value = parsed.name || '';
    document.getElementById('new-recipe-time').value = parsed.time || '';
    document.getElementById('new-recipe-url').value = '';
    document.getElementById('new-recipe-servings').value = defaultServings > 1 ? defaultServings : '';
    document.getElementById('new-recipe-notes').value = parsed.notes || '';
    initIngBuilder('new-recipe-ing-rows');
    populateIngBuilder('new-recipe-ing-rows', normalizedIngredients);

    const servingsNote = defaultServings > 1 ? ` Ingredients divided to 1-serving amounts (recipe makes ${defaultServings}).` : '';
    if (status) status.innerHTML = `<span style="color:var(--accent-dark);">‚úÖ Recipe parsed!${servingsNote} Review the details below and click Save.</span>`;

    // Clear photos
    _photoFiles = [];
    renderPhotoThumbnails();

    // Scroll to form
    document.getElementById('new-recipe-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('new-recipe-name').focus();

  } catch(e) {
    console.error(e);
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è ${escHtml(e.message)}</span>`;
  } finally {
    if (parseBtn) { parseBtn.disabled = false; parseBtn.textContent = '‚ú® Parse Recipe'; }
  }
}

async function importFromUrl() {
  const url = document.getElementById('url-import-input').value.trim();
  const status = document.getElementById('url-import-status');
  if (!url) { toast('Please enter a URL', 'error'); return; }
  if (!url.startsWith('http')) { toast('Please enter a valid URL starting with http', 'error'); return; }

  if (!state.apiKey) {
    status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è An Anthropic API key is required to import from URLs. Add one in ‚öôÔ∏è Settings.</span>`;
    return;
  }

  status.innerHTML = `<span><div class="spinner dark" style="display:inline-block;vertical-align:middle;margin-right:6px;"></div> Fetching and parsing recipe‚Ä¶</span>`;

  try {
    // Fetch the page via a CORS proxy (public, read-only)
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error('Could not fetch the page. The site may block external requests.');
    const data = await res.json();
    const html = data.contents || '';

    // Strip tags to plain text (simple approach)
    const div = document.createElement('div');
    div.innerHTML = html;
    // Remove scripts/styles
    div.querySelectorAll('script,style,nav,footer,header,aside').forEach(el => el.remove());
    const text = div.innerText || div.textContent || '';
    const snippet = text.replace(/\s+/g, ' ').trim().slice(0, 4000);

    if (!snippet) throw new Error('Page appears empty or could not be read.');

    const prompt = `Extract the recipe from this webpage text and return ONLY a JSON object (no markdown):
{
  "name": "Recipe name",
  "time": "total cook/prep time",
  "servings": 4,
  "ingredients": ["1 cup flour", "2 tbsp olive oil", "3 large eggs", ...],
  "notes": "Complete step-by-step cooking instructions, exactly as written on the page. Include all steps, temperatures, times, and techniques. Do not summarize.",
  "url": "${url}"
}

Rules for ingredients:
- List ingredients exactly as they appear for the full recipe yield (not per serving)
- Format each as "qty unit name" e.g. "1 cup flour", "2 tbsp butter", "1/2 tsp salt"
- Use standard units: tsp, tbsp, cup, oz, lb, g, kg, ml, liter, clove, slice, can, bunch, pinch, piece
- If there's no unit (e.g. "3 eggs"), write "3 whole eggs"
- Do NOT include prep notes in the ingredient string (e.g. "chopped", "diced") ‚Äî just qty, unit, name
- Do NOT include "of" between unit and ingredient name
- "servings" must be an integer: the number of servings the full recipe makes (e.g. 4 if it says "serves 4", 1 if unknown)

Webpage text:
${snippet}`;

    const aiData = await callClaude(prompt, 3000);
    const aiText = aiData.content[0].text.trim();
    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Could not parse recipe from page.');
    const parsed = JSON.parse(jsonMatch[0]);

    if (!parsed.name) throw new Error('No recipe name found on page.');

    // Normalize ingredients to per-1-serving
    const defaultServings = Math.max(1, parseInt(parsed.servings) || 1);
    const normalizedIngredients = normalizeIngredientsToOneServing(parsed.ingredients || [], defaultServings);

    // Pre-fill the form
    document.getElementById('new-recipe-name').value = parsed.name || '';
    document.getElementById('new-recipe-time').value = parsed.time || '';
    document.getElementById('new-recipe-url').value = url;
    document.getElementById('new-recipe-servings').value = defaultServings > 1 ? defaultServings : '';
    initIngBuilder('new-recipe-ing-rows');
    populateIngBuilder('new-recipe-ing-rows', normalizedIngredients);
    document.getElementById('new-recipe-notes').value = parsed.notes || '';
    document.getElementById('url-import-input').value = '';

    const servingsNote = defaultServings > 1 ? ` Ingredients divided to 1-serving amounts (recipe makes ${defaultServings}).` : '';
    status.innerHTML = `<span style="color:var(--accent-dark);">‚úÖ Recipe imported!${servingsNote} Review the details below and click Save.</span>`;

    // Scroll to form
    document.getElementById('new-recipe-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
    document.getElementById('new-recipe-name').focus();

  } catch(e) {
    console.error(e);
    status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è ${escHtml(e.message)}</span>`;
  }
}

function renderFavorites() {
  const container = document.getElementById('favorites-grid');
  if (!state.favorites.length) {
    container.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="emoji">‚≠ê</div><h3>No favorites yet</h3><p>Save recipes from search results or meal slots.</p></div>`;
    return;
  }
  container.innerHTML = state.favorites.map((r, i) => recipeCardHTML(r, i, 'favorites')).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderHistory() {
  const container = document.getElementById('history-list');
  if (!state.history.length) {
    container.innerHTML = `<div class="empty-state"><div class="emoji">üìÖ</div><h3>No history yet</h3><p>Save your current week using "Save to History" to track past meal plans.</p></div>`;
    return;
  }

  container.innerHTML = state.history.map((entry, hi) => {
    const mealItems = [];
    DAYS.forEach(day => {
      MEALS.forEach(meal => {
        const key = `${day}-${meal}`;
        const slotVal = entry.plan[key];
        if (slotVal) {
          const meals = Array.isArray(slotVal) ? slotVal : [slotVal];
          const names = meals.map(m => escHtml(m.name)).join(', ');
          mealItems.push(`<div class="history-meal-item">
            <div class="day-label">${day.slice(0,3)} ${meal}</div>
            <div>${names}</div>
          </div>`);
        }
      });
    });

    return `<div class="history-week">
      <h4>
        <span>Week of ${escHtml(entry.weekOf)}</span>
        <button class="btn btn-secondary btn-sm" onclick="loadHistoryWeek(${hi})">üìã Restore week</button>
      </h4>
      <div class="history-meals">${mealItems.join('')}</div>
    </div>`;
  }).join('');
}

function loadHistoryWeek(index) {
  const label = state.weekOffset === 0 ? 'this week' : 'next week';
  if (!confirm(`This will replace ${label}. Continue?`)) return;
  const restoredPlan = JSON.parse(JSON.stringify(state.history[index].plan));
  // Migrate any single-object slots to arrays
  Object.keys(restoredPlan).forEach(slotKey => {
    const val = restoredPlan[slotKey];
    if (val && !Array.isArray(val)) restoredPlan[slotKey] = [val];
  });
  state.plans[state.weekOffset] = restoredPlan;
  state.plan = state.plans[state.weekOffset];
  state.groceryChecked = {};
  saveToStorage();
  switchView('week');
  renderWeekGrid();
  renderGroceryList();
  toast('Week restored!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLAUDE API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function callClaude(prompt, maxTokens = 1024) {
  if (!state.apiKey) throw new Error('No Anthropic API key. Add one in Settings.');

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': state.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }],
    }),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `API error ${res.status}`);
  }

  return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function escHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function escAttr(str) {
  return escHtml(str);
}

function toast(msg, type = '') {
  const ct = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  ct.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SLOT MODAL ‚Äî PHOTO & URL IMPORT WRAPPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _slotPhotoFiles = [];

function initSlotPhotoImport() {
  _slotPhotoFiles = [];
  const input = document.getElementById('slot-photo-file-input');
  if (input) input.value = '';
  renderSlotPhotoThumbnails();
  const status = document.getElementById('slot-photo-import-status');
  if (status) status.innerHTML = '';
}

function addSlotPhotoFiles(fileList) {
  const status = document.getElementById('slot-photo-import-status');
  for (const file of fileList) {
    if (!file.type.startsWith('image/')) {
      if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Only image files are supported.</span>`;
      continue;
    }
    if (_slotPhotoFiles.length >= 3) {
      if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Maximum 3 photos allowed.</span>`;
      break;
    }
    _slotPhotoFiles.push(file);
  }
  const input = document.getElementById('slot-photo-file-input');
  if (input) input.value = '';
  renderSlotPhotoThumbnails();
}

function removeSlotPhoto(index) {
  _slotPhotoFiles.splice(index, 1);
  renderSlotPhotoThumbnails();
}

function renderSlotPhotoThumbnails() {
  const container = document.getElementById('slot-photo-thumbnails');
  const parseBtn  = document.getElementById('slot-photo-parse-btn');
  const addBtn    = document.getElementById('slot-photo-add-btn');
  const clearBtn  = document.getElementById('slot-photo-clear-btn');
  const dropzone  = document.getElementById('slot-photo-dropzone');
  if (!container) return;
  const hasPhotos = _slotPhotoFiles.length > 0;
  if (parseBtn) parseBtn.style.display = hasPhotos ? '' : 'none';
  if (addBtn)   addBtn.style.display   = (hasPhotos && _slotPhotoFiles.length < 3) ? '' : 'none';
  if (clearBtn) clearBtn.style.display = hasPhotos ? '' : 'none';
  if (dropzone) dropzone.style.display = hasPhotos ? 'none' : '';
  if (!hasPhotos) { container.innerHTML = ''; return; }
  container.innerHTML = _slotPhotoFiles.map((file, i) => {
    const url = URL.createObjectURL(file);
    return `<div class="photo-thumb">
      <img src="${url}" alt="Photo ${i+1}" onload="URL.revokeObjectURL(this.src)" />
      <button class="photo-thumb-remove" onclick="removeSlotPhoto(${i})" title="Remove">‚úï</button>
    </div>`;
  }).join('');
}

// Fills the slot modal recipe form fields from a parsed recipe object
function _fillSlotRecipeForm(parsed, sourceUrl) {
  const defaultServings = Math.max(1, parseInt(parsed.servings) || 1);
  const normalizedIngredients = normalizeIngredientsToOneServing(parsed.ingredients || [], defaultServings);
  document.getElementById('slot-recipe-name').value = parsed.name || '';
  document.getElementById('slot-recipe-time').value = parsed.time || '';
  document.getElementById('slot-recipe-url').value = sourceUrl || '';
  document.getElementById('slot-recipe-servings').value = defaultServings > 1 ? defaultServings : '';
  document.getElementById('slot-recipe-notes').value = parsed.notes || '';
  initIngBuilder('slot-recipe-ing-rows');
  populateIngBuilder('slot-recipe-ing-rows', normalizedIngredients);
  return defaultServings;
}

async function parseSlotPhotosWithClaude() {
  const status = document.getElementById('slot-photo-import-status');
  if (!_slotPhotoFiles.length) {
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è Please add at least one photo first.</span>`;
    return;
  }
  if (!state.apiKey) {
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è An Anthropic API key is required. Add one in ‚öôÔ∏è Settings.</span>`;
    return;
  }
  const parseBtn = document.getElementById('slot-photo-parse-btn');
  if (parseBtn) { parseBtn.disabled = true; parseBtn.textContent = 'Parsing‚Ä¶'; }
  if (status) status.innerHTML = `<span><div class="spinner dark" style="display:inline-block;vertical-align:middle;margin-right:6px;"></div> Reading recipe from photo‚Ä¶</span>`;
  try {
    const imageData = await Promise.all(_slotPhotoFiles.map(resizeImageToBase64));
    const content = [
      ...imageData.map(({ base64, mediaType }) => ({
        type: 'image',
        source: { type: 'base64', media_type: mediaType, data: base64 },
      })),
      { type: 'text', text: `Extract the recipe and return ONLY a JSON object (no markdown):\n{"name":"...","time":"...","servings":4,"ingredients":["1 cup flour",...],"notes":"Full step-by-step instructions."}\nList ingredients for the full recipe yield. "servings" = integer serving count.` },
    ];
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': state.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, messages: [{ role: 'user', content }] }),
    });
    if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.error?.message || `API error ${res.status}`); }
    const aiData = await res.json();
    const jsonMatch = aiData.content[0].text.trim().match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Could not parse recipe from the photo. Try a clearer image.');
    const parsed = JSON.parse(jsonMatch[0]);
    if (!parsed.name) throw new Error('No recipe name found. Try a clearer image.');
    const ds = _fillSlotRecipeForm(parsed, '');
    const note = ds > 1 ? ` Ingredients divided to 1-serving amounts (recipe makes ${ds}).` : '';
    if (status) status.innerHTML = `<span style="color:var(--accent-dark);">‚úÖ Recipe parsed!${note} Review and click Save &amp; Add to Plan.</span>`;
    _slotPhotoFiles = [];
    renderSlotPhotoThumbnails();
  } catch(e) {
    console.error(e);
    if (status) status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è ${escHtml(e.message)}</span>`;
  } finally {
    if (parseBtn) { parseBtn.disabled = false; parseBtn.textContent = '‚ú® Parse Recipe'; }
  }
}

async function importFromUrlSlot() {
  const url = document.getElementById('slot-url-import-input').value.trim();
  const status = document.getElementById('slot-url-import-status');
  if (!url) { toast('Please enter a URL', 'error'); return; }
  if (!url.startsWith('http')) { toast('Please enter a valid URL starting with http', 'error'); return; }
  if (!state.apiKey) {
    status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è An Anthropic API key is required. Add one in ‚öôÔ∏è Settings.</span>`;
    return;
  }
  status.innerHTML = `<span><div class="spinner dark" style="display:inline-block;vertical-align:middle;margin-right:6px;"></div> Fetching and parsing recipe‚Ä¶</span>`;
  try {
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error('Could not fetch the page. The site may block external requests.');
    const data = await res.json();
    const div = document.createElement('div');
    div.innerHTML = data.contents || '';
    div.querySelectorAll('script,style,nav,footer,header,aside').forEach(el => el.remove());
    const snippet = (div.innerText || div.textContent || '').replace(/\s+/g, ' ').trim().slice(0, 4000);
    if (!snippet) throw new Error('Page appears empty or could not be read.');
    const prompt = `Extract the recipe from this webpage text and return ONLY a JSON object (no markdown):\n{"name":"...","time":"...","servings":4,"ingredients":["1 cup flour",...],"notes":"Full step-by-step instructions.","url":"${url}"}\nList ingredients for the full recipe yield. "servings" = integer.\n\nWebpage text:\n${snippet}`;
    const aiData = await callClaude(prompt, 3000);
    const jsonMatch = aiData.content[0].text.trim().match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Could not parse recipe from page.');
    const parsed = JSON.parse(jsonMatch[0]);
    if (!parsed.name) throw new Error('No recipe name found on page.');
    const ds = _fillSlotRecipeForm(parsed, url);
    document.getElementById('slot-url-import-input').value = '';
    const note = ds > 1 ? ` Ingredients divided to 1-serving amounts (recipe makes ${ds}).` : '';
    status.innerHTML = `<span style="color:var(--accent-dark);">‚úÖ Recipe imported!${note} Review and click Save &amp; Add to Plan.</span>`;
  } catch(e) {
    console.error(e);
    status.innerHTML = `<span style="color:#dc2626;">‚ö†Ô∏è ${escHtml(e.message)}</span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

init();
</script>
</body>
</html>
